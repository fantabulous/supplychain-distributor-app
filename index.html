<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMG Distributor Order Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for better aesthetics */
        :root {
            --gmg-green: #059669; /* emerald-600 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .scroll-area {
            max-height: calc(100vh - 12rem); /* Adjusted height for header/footer */
            overflow-y: auto;
        }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Custom class for active vertical navigation */
        .active-nav-tab {
            background-color: #ecfdf5; /* emerald-50 */
            color: #047857; /* emerald-700 */
            font-weight: 600;
        }
        .active-nav-tab:hover {
            background-color: #d1fae5; /* slightly darker emerald-100 on hover */
        }
        /* Style for active horizontal product tab */
        .active-product-tab {
            color: #059669; 
            border-color: #059669;
            font-weight: 600;
        }
        /* Ensure text hides cleanly when sidebar collapses */
        .nav-icon {
            transition: margin 0.3s ease;
        }
        /* Style for the dynamic filter checkboxes */
        input[type="checkbox"]:checked {
            border-color: #059669; 
            background-color: #059669;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white card-shadow sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                <span class="text-emerald-600 mr-2">GMG</span> Distributor Portal
            </h1>
            <div class="flex items-center space-x-4">
                <button id="cart-button" class="relative p-2 rounded-full hover:bg-gray-100 transition">
                    <i data-lucide="shopping-cart" class="w-6 h-6 text-gray-600"></i>
                    <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
                </button>
                <div id="user-info" class="text-sm font-medium text-gray-700">
                    User ID: <span id="user-id-display" class="font-mono text-xs bg-gray-100 px-2 py-1 rounded-md">...</span>
                </div>
                <!-- Mobile Navigation Toggle -->
                <button id="mobile-nav-toggle" class="lg:hidden p-2 rounded-full hover:bg-gray-100 transition">
                    <i data-lucide="menu" class="w-6 h-6 text-gray-600"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area - Grid Layout -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- 1. Left Navigation Sidebar (lg:col-span-2) -->
        <div id="left-nav-sidebar" class="lg:col-span-2 hidden lg:block bg-white p-4 rounded-xl card-shadow h-fit sticky top-28 transition-all duration-300">
            <div class="flex justify-between items-center mb-3">
                <h3 id="sidebar-title" class="text-xs font-semibold uppercase text-gray-500 ml-3 transition-opacity duration-300">Menu</h3>
                <button id="sidebar-toggle-desktop" class="p-1 rounded-full text-gray-500 hover:bg-gray-100 transition">
                    <i data-lucide="chevron-left" id="toggle-icon" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div id="sidebar-content">
                <!-- Procure Product (RENAMED to Procure) -->
                <button class="nav-tab w-full text-left p-3 rounded-lg text-sm font-medium transition active-nav-tab flex items-center" data-target="catalog-view">
                    <i data-lucide="layout-grid" class="nav-icon w-4 h-4 mr-2 transition-all duration-300"></i> <span class="sidebar-text transition-opacity duration-300 whitespace-nowrap">Procure</span>
                </button>
                
                <!-- Credit Line (New dedicated entry) -->
                <button class="nav-tab w-full text-left p-3 rounded-lg text-sm font-medium transition text-gray-700 hover:bg-gray-100 mt-1 flex items-center" data-target="dashboard-view">
                    <i data-lucide="wallet" class="nav-icon w-4 h-4 mr-2 transition-all duration-300"></i> <span class="sidebar-text transition-opacity duration-300 whitespace-nowrap">Credit Line</span>
                </button>
                
                <!-- Orders (New dedicated entry) -->
                <button class="nav-tab w-full text-left p-3 rounded-lg text-sm font-medium transition text-gray-700 hover:bg-gray-100 mt-1 flex items-center" data-target="dashboard-view">
                    <i data-lucide="package" class="nav-icon w-4 h-4 mr-2 transition-all duration-300"></i> <span class="sidebar-text transition-opacity duration-300 whitespace-nowrap">Orders</span>
                </button>
            </div>
        </div>

        <!-- Mobile Navigation Drawer -->
        <div id="mobile-nav-drawer" class="fixed inset-0 bg-white z-40 p-6 hidden lg:hidden">
             <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="text-xl font-bold text-gray-800">Navigation</h3>
                <button onclick="document.getElementById('mobile-nav-drawer').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <!-- Procure Product (RENAMED to Procure) -->
            <button class="nav-tab mobile-nav-item w-full text-left p-3 rounded-lg text-lg font-medium transition active-nav-tab mb-2" data-target="catalog-view">
                <i data-lucide="layout-grid" class="w-5 h-5 mr-3 inline-block align-text-bottom"></i> Procure
            </button>
            <!-- Credit Line -->
            <button class="nav-tab mobile-nav-item w-full text-left p-3 rounded-lg text-lg font-medium transition text-gray-700 hover:bg-gray-100 mb-2" data-target="dashboard-view">
                <i data-lucide="wallet" class="w-5 h-5 mr-3 inline-block align-text-bottom"></i> Credit Line
            </button>
            <!-- Orders -->
            <button class="nav-tab mobile-nav-item w-full text-left p-3 rounded-lg text-lg font-medium transition text-gray-700 hover:bg-gray-100" data-target="dashboard-view">
                <i data-lucide="package" class="w-5 h-5 mr-3 inline-block align-text-bottom"></i> Orders
            </button>
        </div>
        
        <!-- 2. View Container (lg:col-span-10 / 12 for mobile) -->
        <div id="view-container" class="lg:col-span-10 col-span-12 transition-all duration-300">

            <!-- 1. Product Catalog View (Procure Product) - Now Tabbed & Grouped -->
            <div id="catalog-view" class="view">
                
                <!-- Product Tabs (Meat Type) -->
                <div id="product-tabs-header" class="flex flex-wrap border-b border-gray-200 bg-white p-3 rounded-xl card-shadow mb-6 sticky top-20 z-0">
                    <!-- Tabs will be dynamically injected here -->
                    <div class="text-gray-500 p-2">Loading product categories...</div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

                    <!-- Filter / Search Sidebar (Now for the active tab) -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl card-shadow h-fit sticky top-40">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="search" class="w-5 h-5 mr-2 text-emerald-600"></i>
                            Quick Search
                        </h2>
                        
                        <!-- Search Input -->
                        <div class="mb-6 border-b pb-4">
                            <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Search SKU/Name</label>
                            <input type="text" id="search-input" placeholder="Search within current type..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                        </div>

                        <!-- Cut Filters (Faceted Search Checkboxes - Dynamic based on active tab) -->
                        <div class="mb-4">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="cut" class="w-5 h-5 mr-2 text-emerald-600"></i>
                                Cut Filters
                            </h2>
                            <div id="filter-cut-container" class="space-y-2 text-sm">
                                <!-- Checkboxes for cuts will be injected here -->
                                <p class="text-gray-400">Select a category...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Product Grid Container -->
                    <div class="lg:col-span-3">
                        <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                            <!-- Product cards will be injected here in a flat grid -->
                            <div class="col-span-full text-center py-10 text-gray-500" id="loading-products">
                                <i data-lucide="loader" class="w-8 h-8 mx-auto animate-spin text-emerald-500 mb-2"></i>
                                Loading products...
                            </div>
                        </div>
                        <div id="no-products" class="hidden col-span-full text-center py-10 text-gray-500 text-lg font-medium">
                            No products match your current search criteria.
                        </div>
                    </div>

                </div>
            </div>

            <!-- 2. Distributor Dashboard View -->
            <div id="dashboard-view" class="view hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Financial Summary & Order Tracking</h2>

                <!-- CREDIT LINE OVERVIEW SECTION -->
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i data-lucide="wallet" class="w-5 h-5 mr-2 text-emerald-600"></i> Credit Line Overview
                </h3>

                <!-- Financial Card -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl card-shadow border-l-4 border-emerald-600">
                        <p class="text-sm font-medium text-gray-500">Total Credit Limit</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1" id="credit-limit">AED 0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl card-shadow border-l-4 border-yellow-500">
                        <p class="text-sm font-medium text-gray-500">Outstanding Balance</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1" id="credit-used">AED 0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl card-shadow border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Available Credit</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1" id="credit-available">AED 0.00</p>
                    </div>
                </div>

                <!-- Credit Utilization Bar -->
                <div class="bg-white p-6 rounded-xl card-shadow mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Credit Utilization</h3>
                    <div class="w-full bg-gray-200 rounded-full h-4 relative">
                        <div id="utilization-bar" class="bg-emerald-600 h-4 rounded-full" style="width: 0%"></div>
                        <span id="utilization-percent" class="absolute right-2 top-0.5 text-xs text-white font-semibold">0%</span>
                    </div>
                </div>
                
                <!-- ORDER TRACKING SECTION -->
                <h3 class="text-xl font-semibold text-gray-800 mb-4 mt-8 flex items-center">
                    <i data-lucide="package" class="w-5 h-5 mr-2 text-emerald-600"></i> Recent Orders and Tracking
                </h3>

                <!-- Order History Table -->
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Value</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Track</th>
                                </tr>
                            </thead>
                            <tbody id="order-history-body" class="bg-white divide-y divide-gray-200">
                                <!-- Orders will be injected here -->
                                <tr>
                                    <td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No orders placed yet.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl w-full max-w-lg card-shadow">
                <!-- Modal Header -->
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center"><i data-lucide="shopping-cart" class="w-5 h-5 mr-2"></i> Shopping Cart</h3>
                    <button onclick="closeModal('cart-modal')" class="text-gray-400 hover:text-gray-600 transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <!-- Modal Body -->
                <div class="p-6 scroll-area">
                    <div id="cart-items-container">
                        <p id="empty-cart-message" class="text-gray-500 text-center py-4 hidden">Your cart is empty. Add some products!</p>
                        <!-- Cart items will be injected here -->
                    </div>
                </div>
                <!-- Modal Footer -->
                <div class="p-6 border-t">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-semibold text-gray-700">Subtotal:</span>
                        <span id="cart-subtotal" class="text-xl font-bold text-emerald-600">AED 0.00</span>
                    </div>
                    <button id="place-order-button" onclick="placeOrder()" class="w-full bg-emerald-600 text-white p-3 rounded-lg hover:bg-emerald-700 transition font-bold disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Place Order
                    </button>
                    <p id="credit-warning" class="text-red-500 text-sm mt-2 hidden text-center font-medium">Order total exceeds available credit line!</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Product Detail Modal -->
    <div id="product-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl w-full max-w-2xl card-shadow">
                <!-- Modal Header -->
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 id="detail-modal-title" class="text-xl font-bold text-gray-800">Product Details</h3>
                    <button onclick="closeModal('product-detail-modal')" class="text-gray-400 hover:text-gray-600 transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <!-- Modal Body -->
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Image and Basic Info -->
                    <div class="md:col-span-1">
                        <img id="detail-image" src="" alt="Product Image" class="w-full h-auto rounded-lg object-cover border border-gray-100 mb-4" onerror="this.onerror=null;this.src='https://placehold.co/100x100/A7F3D0/047857?text=No+Image';">
                        <p class="text-sm text-gray-500">SKU: <span id="detail-sku" class="font-medium text-gray-700"></span></p>
                        <p class="text-sm text-gray-500">Brand: <span id="detail-brand" class="font-medium text-gray-700"></span></p>
                        <p class="text-sm text-gray-500">Inventory: <span id="detail-inventory" class="font-medium text-gray-700"></span></p>
                    </div>

                    <!-- Price, Rating, and Description -->
                    <div class="md:col-span-1">
                        <p class="text-3xl font-extrabold text-emerald-700 mb-2">
                            <span id="detail-price"></span> 
                            <span id="detail-unit" class="text-lg font-normal text-gray-500"></span>
                        </p>
                        <div id="detail-rating" class="mb-4"></div>
                        
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-1 mb-2">Description</h4>
                        <p id="detail-description" class="text-gray-600 text-sm"></p>
                        
                        <!-- Add to Cart controls -->
                        <div class="mt-6 pt-4 border-t">
                            <h4 class="text-md font-semibold text-gray-800 mb-2">Order Quantity</h4>
                            <div class="flex items-center space-x-2">
                                <button id="detail-minus-btn" class="p-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50 transition">
                                    <i data-lucide="minus" class="w-4 h-4"></i>
                                </button>
                                <input type="number" id="detail-qty-input" value="1" min="1" class="font-medium text-lg w-16 text-center border rounded-lg p-1.5 focus:ring-emerald-500 focus:border-emerald-500">
                                <button id="detail-plus-btn" class="p-1.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <button id="detail-add-to-cart-btn" class="w-full bg-emerald-600 text-white p-3 rounded-lg hover:bg-emerald-700 transition font-bold mt-4">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl w-full max-w-sm card-shadow p-6 text-center">
                <h3 id="message-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
                <p id="message-body" class="text-gray-600 mb-6"></p>
                <button onclick="closeModal('message-modal')" class="bg-emerald-600 text-white p-2 w-full rounded-lg hover:bg-emerald-700 transition font-semibold">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = 'loading';
        window.cart = {}; // Global cart object
        window.products = []; // Global product list
        window.distributorProfile = null; // Global profile
        
        // Global state for active filters (Meat Type is now the activeTab)
        window.activeFilters = {
            search: '',
            type: [], 
            cut: []
        };
        
        // State
        window.activeTab = ''; // Used for the dynamic product tabs (Beef, Lamb, Chicken)
        let isSidebarCollapsed = false;

        // Function to show custom message modal
        window.showMessage = (title, body) => {
            const titleEl = document.getElementById('message-title');
            const bodyEl = document.getElementById('message-body');
            const modalEl = document.getElementById('message-modal');

            if (titleEl) titleEl.textContent = title;
            if (bodyEl) bodyEl.textContent = body;
            if (modalEl) modalEl.classList.remove('hidden');
        };

        // Function to close any modal
        window.closeModal = (id) => {
            const modal = document.getElementById(id);
            if(modal) modal.classList.add('hidden');
        };

        // Utility: Format currency
        const formatCurrency = (amount) => {
            return `AED ${parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
        };

        // Helper function for exponential backoff retry logic
        const fetchWithRetry = async (apiCall, maxRetries = 5) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await apiCall();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Retry attempt ${i + 1}/${maxRetries}. Delaying for ${delay / 1000}s.`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

        // --- FIREBASE INITIALIZATION & AUTH ---
        if (firebaseConfig) {
            setLogLevel('debug'); // Enable detailed Firestore logging
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    // Sign in anonymously if no user is found and no custom token is available
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            userId = auth.currentUser.uid;
                        } else {
                            const anonymousUser = await signInAnonymously(auth);
                            userId = anonymousUser.user.uid;
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        showMessage("Authentication Error", "Could not sign into the portal. Check console for details.");
                        return;
                    }
                }
                // Displaying the first 8 characters of the UID
                const userIdDisplay = document.getElementById('user-id-display');
                if (userIdDisplay) {
                    userIdDisplay.textContent = userId.substring(0, 8) + '...';
                }
                
                // Initialize Data Listeners ONLY after successful auth
                initializeDataListeners();
            });
        } else {
            const loadingProducts = document.getElementById('loading-products');
            if (loadingProducts) {
                loadingProducts.innerHTML = `<i data-lucide="alert-triangle" class="w-8 h-8 mx-auto text-red-500 mb-2"></i> Firebase configuration not available. Cannot connect to database.`;
            }
            showMessage("System Error", "Firebase configuration is missing. Data persistence is unavailable.");
        }

        // --- FIRESTORE DATA LISTENERS ---
        const initializeDataListeners = () => {
            if (!db || !userId) return;

            const distributorDocRef = doc(db, "artifacts", appId, "users", userId, "profile", "data");
            const productsCollectionRef = collection(db, "artifacts", appId, "public", "data", "products");
            const ordersCollectionRef = collection(db, "artifacts", appId, "users", userId, "orders");

            // 1. Listen to Distributor Profile (Credit Line)
            onSnapshot(distributorDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.distributorProfile = docSnap.data();
                } else {
                    // Create a default profile if it doesn't exist
                    window.distributorProfile = {
                        creditLimit: 250000,
                        outstandingBalance: 0,
                    };
                    setDoc(distributorDocRef, window.distributorProfile, { merge: true })
                        .catch(e => console.error("Error setting initial profile:", e));
                }
                renderDashboard();
            }, (error) => {
                console.error("Error listening to distributor profile:", error);
            });

            // 2. Listen to Products (Catalog)
            onSnapshot(productsCollectionRef, (snapshot) => {
                window.products = [];
                snapshot.forEach(doc => {
                    window.products.push({ id: doc.id, ...doc.data() });
                });
                renderProductTabs(); // NEW: Render tabs and default product view
                
                const loadingEl = document.getElementById('loading-products');
                if (loadingEl) {
                    loadingEl.classList.add('hidden');
                }
            }, (error) => {
                console.error("Error listening to products:", error);
                const loadingEl = document.getElementById('loading-products');
                if (loadingEl) {
                    loadingEl.innerHTML = 'Error loading products.';
                }
            });

            // 3. Listen to Orders
            onSnapshot(query(ordersCollectionRef), (snapshot) => {
                let orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                renderOrderHistory(orders);
            }, (error) => {
                console.error("Error listening to orders:", error);
            });

            // Populate mock data if collections are empty (for first-time use)
            fetchWithRetry(() => initializeMockData(productsCollectionRef, ordersCollectionRef));
        };

        // --- MOCK DATA INITIALIZATION ---
        const initializeMockData = async (productsCollectionRef, ordersCollectionRef) => {
            const productsSnapshot = await getDocs(productsCollectionRef);
            if (productsSnapshot.empty) {
                console.log("Populating mock product data.");
                // Placeholder image for all products
                const defaultImageUrl = "https://placehold.co/100x100/34D399/FFFFFF/png?text=GMG+Meat";
                
                const mockProducts = [
                    // Added 'unit', 'imageUrl', 'rating' and 'description' fields
                    { sku: 'BEEF-STEAK-RBY-10KG', name: 'Premium Beef Ribeye Steak (Frozen)', brand: 'GMG Select', type: 'Beef', cut: 'Steak', unit: 'kg', unitPrice: 850.00, inventory: 50, imageUrl: defaultImageUrl, rating: 4.8, description: "Highly marbled, tender Ribeye steak, individually vacuum-sealed and flash-frozen to lock in flavor and freshness. Ideal for high-end restaurants and large catering events." },
                    { sku: 'LAMB-LOIN-CHLD-5KG', name: 'Chilled Australian Lamb Loin', brand: 'Down Under', type: 'Lamb', cut: 'Loin', unit: 'kg', unitPrice: 520.00, inventory: 80, imageUrl: defaultImageUrl, rating: 4.5, description: "Prime grade, chilled lamb loin sourced from certified Australian farms. Perfect for carving or portioning into individual chops. Delivered fresh, never frozen." },
                    { sku: 'CHICKEN-GROUND-1KG', name: 'Bulk Ground Chicken Breast (Chilled)', brand: 'PoultryPro', type: 'Chicken', cut: 'Ground', unit: 'kg', unitPrice: 85.00, inventory: 120, imageUrl: defaultImageUrl, rating: 4.2, description: "Lean ground chicken breast, suitable for health-conscious menus and mass preparation. Low fat content and consistently textured for uniform cooking." },
                    { sku: 'BEEF-TEND-SLCT-1KG', name: 'Wagyu Beef Tenderloin A5', brand: 'Kobe Reserve', type: 'Beef', cut: 'Steak', unit: 'g', unitPrice: 15.00, inventory: 20, imageUrl: defaultImageUrl, rating: 5.0, description: "The pinnacle of beef quality. Genuine A5 Wagyu Tenderloin, known for its extreme tenderness and rich, buttery marbling. Sold by the gram for specialty orders." },
                    { sku: 'LAMB-SHANK-FRZ-10KG', name: 'Frozen New Zealand Lamb Shank', brand: 'Down Under', type: 'Lamb', cut: 'Loin', unit: 'box', unitPrice: 480.00, inventory: 65, imageUrl: defaultImageUrl, rating: 3.9, description: "Classic New Zealand lamb shanks, bone-in and pre-trimmed. Excellent for slow cooking, braising, or stews. Conveniently packaged in 10kg bulk boxes." },
                    { sku: 'BEEF-GROUND-8020-5KG', name: '80/20 Lean Ground Beef', brand: 'GMG Select', type: 'Beef', cut: 'Ground', unit: 'kg', unitPrice: 350.00, inventory: 150, imageUrl: defaultImageUrl, rating: 4.1, description: "Standard 80% lean, 20% fat ground beef blend. Versatile for burgers, meatballs, and taco filling. Comes in 5kg vacuum-sealed packs." },
                    { sku: 'CHICKEN-THIGH-FRZ', name: 'Frozen Chicken Thighs (Bone-in)', brand: 'PoultryPro', type: 'Chicken', cut: 'Thigh', unit: 'piece', unitPrice: 2.50, inventory: 8, imageUrl: defaultImageUrl, rating: 4.6, description: "Individually frozen, bone-in chicken thighs. A cost-effective and flavorful option for large volume cooking. Consistent size for easy portion control." }, 
                    { sku: 'LAMB-CUBE-CHLD', name: 'Chilled Lamb Diced Cubes', brand: 'Down Under', type: 'Lamb', cut: 'Cube', unit: 'kg', unitPrice: 400.00, inventory: 90, imageUrl: defaultImageUrl, rating: 4.7, description: "Pre-diced, chilled lamb cubes ready for kebabs, curries, or roasting. Saves prep time and ensures uniform cooking size." },
                    { sku: 'BEEF-FILLET-FRZ-5KG', name: 'Frozen Beef Fillet Whole Muscle', brand: 'GMG Select', type: 'Beef', cut: 'Loin', unit: 'box', unitPrice: 700.00, inventory: 40, imageUrl: defaultImageUrl, rating: 4.9, description: "Whole frozen beef fillet, suitable for slicing into filet mignon or chateaubriand. Excellent quality and value for large volume needs." },
                ];

                for (const prod of mockProducts) {
                    await addDoc(productsCollectionRef, prod).catch(e => console.error("Error adding mock product:", e));
                }
            }

            // Orders can be populated based on the products. We need to fetch the newly created products first.
            const updatedProductsSnapshot = await getDocs(productsCollectionRef);
            const productsMap = {};
            updatedProductsSnapshot.forEach(doc => {
                productsMap[doc.id] = { id: doc.id, ...doc.data() };
            });

            const ordersSnapshot = await getDocs(ordersCollectionRef);
            if (ordersSnapshot.empty && Object.keys(productsMap).length >= 3) {
                console.log("Populating mock order data.");
                
                const productIds = Object.keys(productsMap);
                const p1 = productsMap[productIds[0]]; 
                const p2 = productsMap[productIds[1]]; 
                const p3 = productsMap[productIds[6]]; 

                const mockOrders = [
                    // Delivered Order
                    { 
                        items: [{...p1, quantity: 2, unit: p1.unit}, {...p3, quantity: 50, unit: p3.unit}], 
                        totalAmount: (p1.unitPrice * 2) + (p3.unitPrice * 50),
                        status: 'Delivered',
                        timestamp: serverTimestamp(),
                        distributorId: userId
                    },
                    // Shipped Order
                    { 
                        items: [{...p2, quantity: 3, unit: p2.unit}], 
                        totalAmount: p2.unitPrice * 3,
                        status: 'Shipped',
                        timestamp: serverTimestamp(),
                        distributorId: userId
                    },
                    // Processing Order (Contributes to outstanding balance)
                    {
                        items: [{...p1, quantity: 1, unit: p1.unit}, {...p2, quantity: 1, unit: p2.unit}],
                        totalAmount: p1.unitPrice + p2.unitPrice,
                        status: 'Processing',
                        timestamp: serverTimestamp(),
                        distributorId: userId
                    }
                ];
                
                let totalOutstanding = 0;
                for (const order of mockOrders) {
                    await addDoc(ordersCollectionRef, order).catch(e => console.error("Error adding mock order:", e));
                    if (order.status === 'Processing' || order.status === 'Shipped') {
                         totalOutstanding += order.totalAmount;
                    }
                }
                
                // Update profile with mock outstanding balance from processing/shipped orders
                const distributorDocRef = doc(db, "artifacts", appId, "users", userId, "profile", "data");
                await updateDoc(distributorDocRef, {
                    outstandingBalance: totalOutstanding,
                    creditLimit: 250000,
                }).catch(e => console.error("Error setting initial profile balance:", e));
            }
        };

        // --- TAB & FILTER UX LOGIC ---

        // Renders the Meat Type tabs
        const renderProductTabs = () => {
            if (window.products.length === 0) return;

            const uniqueTypes = [...new Set(window.products.map(p => p.type))].sort();
            const container = document.getElementById('product-tabs-header');
            
            if (!container) return; // Guard for safety

            if (!window.activeTab || !uniqueTypes.includes(window.activeTab)) {
                // Set default tab to the first type if not already set or invalid
                window.activeTab = uniqueTypes[0];
            }

            container.innerHTML = uniqueTypes.map(type => {
                const isActive = type === window.activeTab;
                return `
                    <button onclick="switchProductTab('${type}')"
                            class="product-tab px-4 py-2 text-sm md:text-base border-b-2 border-transparent transition hover:text-emerald-700 hover:border-emerald-300 ${isActive ? 'active-product-tab' : 'text-gray-500'}"
                            data-type="${type}">
                        ${type}
                    </button>
                `;
            }).join('');
            
            // Now that tabs are rendered, refresh filters and catalog
            renderFilterCheckboxes();
            renderProductCatalog();
        };

        // Switches the active tab and triggers catalog refresh
        window.switchProductTab = (type) => {
            window.activeTab = type;
            // Clear search and cut filters when switching tabs for a clean slate
            const searchInput = document.getElementById('search-input');
            if(searchInput) searchInput.value = '';
            
            window.activeFilters.search = '';
            window.activeFilters.cut = [];
            
            // Rerender to update active tab style
            renderProductTabs(); 
        };


        // Generates and renders CUT checkboxes only for products in the active tab
        const renderFilterCheckboxes = () => {
            const container = document.getElementById('filter-cut-container');
            if (!container || !window.activeTab) {
                if(container) container.innerHTML = `<p class="text-gray-400">Select a category...</p>`;
                return;
            }

            // Filter products to only include the active type
            const productsInActiveTab = window.products.filter(p => p.type === window.activeTab);
            const uniqueCuts = [...new Set(productsInActiveTab.map(p => p.cut))].sort();

            if (uniqueCuts.length === 0) {
                container.innerHTML = `<p class="text-gray-400">No specific cuts available.</p>`;
                return;
            }

            container.innerHTML = uniqueCuts.map(value => {
                const isChecked = window.activeFilters.cut.includes(value);
                return `
                    <div class="flex items-center">
                        <input id="cut-${value.toLowerCase().replace(/\s/g, '-')}" 
                            type="checkbox" 
                            value="${value}" 
                            onchange="handleFilterChange('cut', '${value}', this.checked)"
                            ${isChecked ? 'checked' : ''}
                            class="h-4 w-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                        <label for="cut-${value.toLowerCase().replace(/\s/g, '-')}" 
                            class="ml-3 text-gray-700 cursor-pointer hover:text-emerald-600 transition">
                            ${value}
                        </label>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons(); // Re-render icons after DOM update
        };
        
        // Handles filter change (for cuts) and triggers product re-render
        window.handleFilterChange = (filterName, value, isChecked) => {
            let filterArray = window.activeFilters[filterName];

            if (isChecked) {
                if (!filterArray.includes(value)) {
                    filterArray.push(value);
                }
            } else {
                window.activeFilters[filterName] = filterArray.filter(item => item !== value);
            }
            
            // Re-render product grid immediately
            renderProductCatalog();
        };


        // --- RENDERING FUNCTIONS ---
        
        // Helper function to generate star rating HTML
        const renderRating = (rating) => {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.25 && rating % 1 <= 0.75;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            
            let starsHtml = '';
            const starClass = "w-4 h-4 fill-yellow-400 text-yellow-400";
            
            // Full stars
            for (let i = 0; i < fullStars; i++) {
                starsHtml += `<i data-lucide="star" class="${starClass}"></i>`;
            }
            // Half star
            if (halfStar) {
                starsHtml += `<span class="relative"><i data-lucide="star" class="${starClass}"></i></span>`;
            }
            // Empty stars
            for (let i = 0; i < emptyStars; i++) {
                starsHtml += `<i data-lucide="star" class="w-4 h-4 text-gray-300"></i>`;
            }

            return `
                <div class="flex items-center space-x-0.5 mt-1">
                    ${starsHtml}
                    <span class="ml-2 text-sm font-semibold text-gray-700">${rating.toFixed(1)}</span>
                </div>
            `;
        };


        // Render individual product card
        const createProductCard = (product) => {
            const inCartQuantity = window.cart[product.id] ? window.cart[product.id].quantity : 0;
            const unitDisplay = product.unit ? `/ ${product.unit}` : '/ unit';

            return `
                <div id="product-${product.id}" 
                     onclick="renderProductDetailModal('${product.id}')"
                     class="bg-white p-4 rounded-xl card-shadow flex flex-col justify-between hover:ring-2 hover:ring-emerald-500 transition-all duration-300 cursor-pointer">
                    
                    <div class="flex justify-between items-start mb-3">
                         <!-- Product Image -->
                        <div class="w-1/4 flex-shrink-0 mr-3">
                            <img src="${product.imageUrl}" 
                                 alt="${product.name}" 
                                 class="w-full h-auto rounded-lg object-cover border border-gray-100" 
                                 onerror="this.onerror=null;this.src='https://placehold.co/100x100/A7F3D0/047857?text=No+Image';">
                        </div>
                        
                        <!-- Product Details & Rating -->
                        <div class="flex-grow">
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white bg-emerald-500">${product.type} - ${product.cut}</span>
                            <h3 class="text-lg font-bold text-gray-800 mt-2 leading-tight">${product.name}</h3>
                            <p class="text-sm text-gray-500">${product.brand} (SKU: ${product.sku})</p>
                            ${renderRating(product.rating)}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-end mt-2 pt-4 border-t border-gray-100">
                         <!-- Price -->
                        <div class="flex-grow">
                            <p class="text-xl font-extrabold text-emerald-700">${formatCurrency(product.unitPrice)} <span class="text-sm font-normal text-gray-500">${unitDisplay}</span></p>
                        </div>
                        
                        <!-- Quantity Controls -->
                        <div class="flex flex-col items-end">
                            <!-- This div stops the card click opening the modal when quantity buttons are pressed -->
                            <div class="flex items-center space-x-2" onclick="event.stopPropagation()">
                                <button onclick="updateCart('${product.id}', -1, false)" class="p-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50 transition" ${inCartQuantity === 0 ? 'disabled' : ''}>
                                    <i data-lucide="minus" class="w-4 h-4"></i>
                                </button>
                                <span class="font-medium text-lg w-8 text-center" id="qty-${product.id}">${inCartQuantity}</span>
                                <button onclick="updateCart('${product.id}', 1, false)" class="p-1.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                             ${inCartQuantity > 0 ? `<span class="text-xs text-gray-600 font-medium mt-1">In Cart</span>` : `<span class="text-xs text-gray-400 mt-1">Add to order</span>`}
                        </div>
                    </div>
                </div>
            `;
        };
        
        // Render the Product Detail Modal
        window.renderProductDetailModal = (productId) => {
            const product = window.products.find(p => p.id === productId);
            const modal = document.getElementById('product-detail-modal');
            
            if (!product || !modal) return;
            
            const unitDisplay = product.unit ? `/ ${product.unit}` : '/ unit';
            
            // Populate content
            document.getElementById('detail-modal-title').textContent = product.name;
            document.getElementById('detail-image').src = product.imageUrl;
            document.getElementById('detail-sku').textContent = product.sku;
            document.getElementById('detail-brand').textContent = product.brand;
            document.getElementById('detail-inventory').textContent = `${product.inventory} ${product.unit}s remaining`;
            document.getElementById('detail-price').textContent = formatCurrency(product.unitPrice);
            document.getElementById('detail-unit').textContent = unitDisplay;
            document.getElementById('detail-rating').innerHTML = renderRating(product.rating);
            document.getElementById('detail-description').textContent = product.description;
            
            // Setup quantity controls
            const qtyInput = document.getElementById('detail-qty-input');
            if (qtyInput) qtyInput.value = 1; // Reset to 1 every time modal opens
            
            const updateDetailQuantity = (change) => {
                const currentQty = parseInt(qtyInput.value, 10);
                const newQty = Math.max(1, currentQty + change);
                qtyInput.value = newQty;
            };

            const minusBtn = document.getElementById('detail-minus-btn');
            if (minusBtn) minusBtn.onclick = () => updateDetailQuantity(-1);
            
            const plusBtn = document.getElementById('detail-plus-btn');
            if (plusBtn) plusBtn.onclick = () => updateDetailQuantity(1);

            // Setup Add to Cart button (FIX: Call updateCart with isSetQuantity=true)
            const addToCartBtn = document.getElementById('detail-add-to-cart-btn');
            if (addToCartBtn) {
                addToCartBtn.onclick = () => {
                    const quantity = parseInt(qtyInput.value, 10);
                    // Pass the total quantity and indicate it's a bulk set operation
                    updateCart(productId, quantity, true); 
                    closeModal('product-detail-modal');
                };
            }

            // Show modal
            lucide.createIcons();
            modal.classList.remove('hidden');
        };

        // Render the main product catalog grid (REVERTED TO FLAT GRID)
        window.renderProductCatalog = () => {
            const container = document.getElementById('product-grid');
            const searchInputEl = document.getElementById('search-input');
            const noProductsEl = document.getElementById('no-products');

            // CRITICAL: Guard against null elements if render is called before DOM is fully ready
            if (!container || !searchInputEl || !noProductsEl || !window.activeTab) {
                console.warn('DOM elements not ready or activeTab not set for renderProductCatalog.');
                return; 
            }
            
            const searchInput = searchInputEl.value.toLowerCase();
            const activeCuts = window.activeFilters.cut;

            // 1. Filter products based on active tab, search, and selected cuts
            let filteredProducts = window.products.filter(p => p.type === window.activeTab);

            filteredProducts = filteredProducts.filter(p => {
                const searchMatch = (
                    p.name.toLowerCase().includes(searchInput) ||
                    p.sku.toLowerCase().includes(searchInput) ||
                    p.brand.toLowerCase().includes(searchInput)
                );
                const cutMatch = activeCuts.length === 0 || activeCuts.includes(p.cut);
                return searchMatch && cutMatch;
            }).sort((a, b) => a.name.localeCompare(b.name));
            
            // Revert: Output a single flat grid, removing sub-section logic
            const htmlContent = filteredProducts.map(createProductCard).join('');
            
            container.innerHTML = htmlContent;

            // Show/hide no products message
            noProductsEl.classList.toggle('hidden', filteredProducts.length > 0);

            // Re-render icons for new elements
            lucide.createIcons();
        };


        // Render distributor dashboard details
        window.renderDashboard = () => {
            if (!window.distributorProfile) return;

            const { creditLimit, outstandingBalance } = window.distributorProfile;
            const availableCredit = creditLimit - outstandingBalance;
            const utilization = (outstandingBalance / creditLimit) * 100;

            const creditLimitEl = document.getElementById('credit-limit');
            const creditUsedEl = document.getElementById('credit-used');
            const creditAvailableEl = document.getElementById('credit-available');
            const utilizationBar = document.getElementById('utilization-bar');
            const utilizationPercent = document.getElementById('utilization-percent');
            
            if (creditLimitEl) creditLimitEl.textContent = formatCurrency(creditLimit);
            if (creditUsedEl) creditUsedEl.textContent = formatCurrency(outstandingBalance);
            if (creditAvailableEl) creditAvailableEl.textContent = formatCurrency(availableCredit);
            
            if (utilizationBar && utilizationPercent) {
                utilizationBar.style.width = `${Math.min(utilization, 100)}%`;
                utilizationPercent.textContent = `${Math.min(utilization.toFixed(1), 100)}%`;
                
                // Change color if utilization is high
                if (utilization > 80) {
                    utilizationBar.classList.remove('bg-emerald-600');
                    utilizationBar.classList.add('bg-red-500');
                } else {
                    utilizationBar.classList.remove('bg-red-500');
                    utilizationBar.classList.add('bg-emerald-600');
                }
            }
        };

        // Render order history table
        const renderOrderHistory = (orders) => {
            const container = document.getElementById('order-history-body');
            if (!container) return;
            
            if (orders.length === 0) {
                container.innerHTML = `<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No orders placed yet.</td></tr>`;
                return;
            }

            // Sort by latest date. Added null check for timestamp before calling toDate().
            orders.sort((a, b) => {
                const dateA = a.timestamp ? a.timestamp.toDate() : new Date(0); // Use epoch date for null timestamps (will appear first)
                const dateB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                return dateB - dateA; // Sort descending (newest first)
            });

            container.innerHTML = orders.map(order => {
                // Also add null check for timestamp rendering
                const date = order.timestamp ? new Date(order.timestamp.toDate()).toLocaleDateString() : 'N/A';
                const statusColor = {
                    'Delivered': 'bg-green-100 text-green-800',
                    'Shipped': 'bg-blue-100 text-blue-800',
                    'Processing': 'bg-yellow-100 text-yellow-800',
                    'Canceled': 'bg-red-100 text-red-800'
                }[order.status] || 'bg-gray-100 text-gray-800';

                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.id.substring(0, 8)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-emerald-600">${formatCurrency(order.totalAmount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${order.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 hover:text-blue-800 cursor-pointer">
                            ${order.status === 'Shipped' ? 'Tracking Link' : 'View Details'}
                        </td>
                    </tr>
                `;
            }).join('');
        };

        // --- CART LOGIC ---
        
        // FIX: Added 'isSetQuantity' parameter to distinguish between incremental updates (catalog grid)
        // and setting the total quantity (product detail modal).
        window.updateCart = (productId, value, isSetQuantity = false) => {
            const product = window.products.find(p => p.id === productId);
            if (!product) return;

            let newQuantity;

            if (isSetQuantity) {
                // From Detail Modal: value is the desired total quantity
                newQuantity = Math.max(0, value);
            } else {
                // From Catalog Grid/Cart Modal: value is the change (+1 or -1)
                const currentQty = window.cart[productId] ? window.cart[productId].quantity : 0;
                newQuantity = Math.max(0, currentQty + value);
            }

            if (newQuantity > 0) {
                window.cart[productId] = { ...product, quantity: newQuantity, unit: product.unit };
            } else {
                delete window.cart[productId];
            }

            // Re-render everything
            renderProductCatalog();
            const cartModal = document.getElementById('cart-modal');
            if (cartModal && !cartModal.classList.contains('hidden')) {
                renderCartModal();
            }
            updateCartCount();
        };

        // Update the cart icon count
        const updateCartCount = () => {
            const count = Object.values(window.cart).reduce((sum, item) => sum + item.quantity, 0);
            const cartCountEl = document.getElementById('cart-count');
            if (cartCountEl) {
                cartCountEl.textContent = count;
            }
        };

        // Render the cart modal content
        window.renderCartModal = () => {
            const container = document.getElementById('cart-items-container');
            const subtotalEl = document.getElementById('cart-subtotal');
            const emptyMsg = document.getElementById('empty-cart-message');
            const placeOrderBtn = document.getElementById('place-order-button');
            const creditWarning = document.getElementById('credit-warning');
            
            if (!container || !subtotalEl || !emptyMsg || !placeOrderBtn || !creditWarning) return;

            const cartItems = Object.values(window.cart);
            let subtotal = 0;

            if (cartItems.length === 0) {
                container.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                subtotalEl.textContent = formatCurrency(0);
                placeOrderBtn.disabled = true;
                creditWarning.classList.add('hidden');
                return;
            }

            emptyMsg.classList.add('hidden');
            container.innerHTML = cartItems.map(item => {
                const lineTotal = item.unitPrice * item.quantity;
                subtotal += lineTotal;
                // Display unit in the cart modal
                const unitText = item.unit ? `(${item.unit})` : '';

                return `
                    <div class="flex items-center justify-between border-b last:border-b-0 py-3">
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-500">${item.sku}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="updateCart('${item.id}', -1, false)" class="text-gray-500 hover:text-red-500 transition"><i data-lucide="minus-circle" class="w-5 h-5"></i></button>
                            <!-- Cart quantity display adjusted to handle units -->
                            <span class="font-medium w-12 text-center">${item.quantity} ${unitText}</span>
                            <button onclick="updateCart('${item.id}', 1, false)" class="text-gray-500 hover:text-emerald-500 transition"><i data-lucide="plus-circle" class="w-5 h-5"></i></button>
                        </div>
                        <span class="text-sm font-bold w-24 text-right">${formatCurrency(lineTotal)}</span>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons(); // Render icons inside modal

            subtotalEl.textContent = formatCurrency(subtotal);

            const availableCredit = window.distributorProfile ? window.distributorProfile.creditLimit - window.distributorProfile.outstandingBalance : 0;
            
            if (subtotal > availableCredit) {
                creditWarning.classList.remove('hidden');
                placeOrderBtn.disabled = true;
                placeOrderBtn.textContent = 'Credit Limit Exceeded';
            } else {
                creditWarning.classList.add('hidden');
                placeOrderBtn.disabled = false;
                placeOrderBtn.textContent = 'Place Order';
            }
        };

        // Place the order (Firestore write)
        window.placeOrder = async () => {
            const cartItems = Object.values(window.cart);
            if (cartItems.length === 0) return;

            const totalAmount = cartItems.reduce((sum, item) => sum + item.unitPrice * item.quantity, 0);
            
            if (totalAmount > (window.distributorProfile.creditLimit - window.distributorProfile.outstandingBalance)) {
                showMessage("Order Failed", "The total amount exceeds your available credit line. Please adjust your order.");
                return;
            }

            closeModal('cart-modal');
            showMessage("Order Processing", "Your order is being submitted and credit checked...");

            try {
                // 1. Create the Order Document
                // Strip unnecessary product details before saving order items, but keep 'unit'
                const itemsToSave = cartItems.map(item => ({
                    id: item.id,
                    sku: item.sku,
                    name: item.name,
                    unitPrice: item.unitPrice,
                    quantity: item.quantity,
                    unit: item.unit // Ensure the unit is saved with the order
                }));

                const newOrder = {
                    distributorId: userId,
                    items: itemsToSave,
                    totalAmount: totalAmount,
                    status: 'Processing',
                    timestamp: serverTimestamp(),
                };
                
                const ordersCollectionRef = collection(db, "artifacts", appId, "users", userId, "orders");
                await addDoc(ordersCollectionRef, newOrder);

                // 2. Update Distributor Credit Line
                const distributorDocRef = doc(db, "artifacts", appId, "users", userId, "profile", "data");
                const newOutstandingBalance = window.distributorProfile.outstandingBalance + totalAmount;
                
                await updateDoc(distributorDocRef, {
                    outstandingBalance: newOutstandingBalance
                });

                // 3. Clear the Cart and notify
                window.cart = {};
                updateCartCount();
                renderProductCatalog();
                showMessage("Order Placed Successfully!", `Your order for ${formatCurrency(totalAmount)} has been placed and is now in 'Processing'. Your outstanding balance has been updated.`);

            } catch (error) {
                console.error("Order Placement Error:", error);
                showMessage("Order Failed", "There was an error placing your order. Please try again. (Details in console)");
            }
        };

        // --- SIDEBAR COLLAPSE LOGIC ---
        
        // Toggles the desktop sidebar collapse state
        const toggleSidebar = () => {
            isSidebarCollapsed = !isSidebarCollapsed;

            const sidebar = document.getElementById('left-nav-sidebar');
            const viewContainer = document.getElementById('view-container');
            const toggleIcon = document.getElementById('toggle-icon');
            const sidebarTitle = document.getElementById('sidebar-title');
            
            if (!sidebar || !viewContainer || !toggleIcon || !sidebarTitle) return;

            // 1. Toggle sidebar width/span
            sidebar.classList.toggle('lg:col-span-2', !isSidebarCollapsed);
            sidebar.classList.toggle('lg:col-span-1', isSidebarCollapsed);
            
            // 2. Toggle view container width/span
            viewContainer.classList.toggle('lg:col-span-10', !isSidebarCollapsed);
            viewContainer.classList.toggle('lg:col-span-11', isSidebarCollapsed);

            // 3. Adjust sidebar content styling for collapsed state
            document.querySelectorAll('#sidebar-content .nav-tab').forEach(button => {
                // Change button alignment for icon-only view
                button.classList.toggle('justify-center', isSidebarCollapsed); 
                button.classList.toggle('text-left', !isSidebarCollapsed); 
                // Reduce horizontal padding for narrower look
                button.classList.toggle('px-3', !isSidebarCollapsed); 
                button.classList.toggle('px-1', isSidebarCollapsed); 
            });


            // 4. Hide/Show text content and adjust icon margin
            document.querySelectorAll('.sidebar-text').forEach(el => {
                el.classList.toggle('opacity-0', isSidebarCollapsed);
                el.classList.toggle('hidden', isSidebarCollapsed);
            });
            
            // Hide Menu Title
            sidebarTitle.classList.toggle('hidden', isSidebarCollapsed);

            // Adjust margin for icons
            document.querySelectorAll('.nav-icon').forEach(el => {
                 el.classList.toggle('mr-2', !isSidebarCollapsed);
                 el.classList.toggle('mr-0', isSidebarCollapsed);
            });
            
            // Toggle icon (Chevron Left/Right)
            toggleIcon.setAttribute('data-lucide', isSidebarCollapsed ? 'chevron-right' : 'chevron-left');
            
            lucide.createIcons();
        };

        // --- UI EVENT HANDLERS ---
        
        // Function to set up all event listeners after DOM is loaded
        const setupEventListeners = () => {
            // Open Cart Modal
            const cartButton = document.getElementById('cart-button');
            if (cartButton) {
                cartButton.addEventListener('click', () => {
                    renderCartModal();
                    document.getElementById('cart-modal').classList.remove('hidden');
                });
            }
            
            // Desktop Sidebar Toggle Logic
            const sidebarToggle = document.getElementById('sidebar-toggle-desktop');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }

            // Tab Switching Logic (for left nav)
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    // Determine the button that was clicked (handling the case where the icon is clicked)
                    const clickedButton = e.target.closest('.nav-tab');
                    if (!clickedButton) return; 

                    const targetViewId = clickedButton.getAttribute('data-target');

                    // Update desktop nav styles
                    document.querySelectorAll('#left-nav-sidebar .nav-tab').forEach(t => {
                        t.classList.remove('active-nav-tab');
                        t.classList.add('text-gray-700', 'hover:bg-gray-100');
                    });
                    // Find and update the corresponding desktop button (if one exists)
                    const desktopButton = document.querySelector(`#left-nav-sidebar .nav-tab[data-target="${targetViewId}"]`);
                    if (desktopButton) {
                        desktopButton.classList.add('active-nav-tab');
                        desktopButton.classList.remove('text-gray-700', 'hover:bg-gray-100');
                    }
                    
                    // Update mobile nav styles
                    document.querySelectorAll('#mobile-nav-drawer .nav-tab').forEach(t => {
                        t.classList.remove('active-nav-tab');
                        t.classList.add('text-gray-700', 'hover:bg-gray-100');
                    });
                    // Find and update the corresponding mobile button (if one exists)
                    const mobileButton = document.querySelector(`#mobile-nav-drawer .nav-tab[data-target="${targetViewId}"]`);
                    if (mobileButton) {
                        mobileButton.classList.add('active-nav-tab');
                        mobileButton.classList.remove('text-gray-700', 'hover:bg-gray-100');
                    }


                    // Switch view content
                    document.querySelectorAll('.view').forEach(view => {
                        view.classList.add('hidden');
                    });
                    const targetView = document.getElementById(targetViewId);
                    if (targetView) {
                        targetView.classList.remove('hidden');
                    }
                    
                    // Hide mobile drawer after selection
                    const mobileDrawer = document.getElementById('mobile-nav-drawer');
                    if (mobileDrawer) {
                        mobileDrawer.classList.add('hidden');
                    }


                    // If switching to dashboard, re-render
                    if (targetViewId === 'dashboard-view') {
                        renderDashboard();
                    } else if (targetViewId === 'catalog-view') {
                        // If returning to catalog, ensure tabs/products are rendered
                        renderProductTabs();
                    }
                    
                    lucide.createIcons(); // Re-render icons on new view
                });
            });

            // Mobile Nav Toggle
            const mobileNavToggle = document.getElementById('mobile-nav-toggle');
            if (mobileNavToggle) {
                mobileNavToggle.addEventListener('click', () => {
                    const mobileDrawer = document.getElementById('mobile-nav-drawer');
                    if (mobileDrawer) {
                        mobileDrawer.classList.remove('hidden');
                    }
                });
            }

            // Attach live search input listener
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', renderProductCatalog);
            }

            // Ensure the main nav sidebar is visible on large screens by default
            const navSidebar = document.getElementById('left-nav-sidebar');
            if (navSidebar && window.innerWidth >= 1024) { // Tailwind's 'lg' breakpoint
                navSidebar.classList.remove('hidden');
            }
        };

        // Initialize on DOMContentLoaded to ensure all elements are available before listeners are attached
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupEventListeners();
        });

    </script>
</body>
</html>
