<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMG Distributor Order Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for better aesthetics */
        :root {
            --gmg-green: #059669; /* emerald-600 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .scroll-area {
            max-height: calc(100vh - 12rem); /* Adjusted height for header/footer */
            overflow-y: auto;
        }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Custom class for active vertical navigation */
        .active-nav-tab {
            background-color: #ecfdf5; /* emerald-50 */
            color: #047857; /* emerald-700 */
            font-weight: 600;
        }
        .active-nav-tab:hover {
            background-color: #d1fae5; /* slightly darker emerald-100 on hover */
        }
        /* Style for active horizontal product tab */
        .active-product-tab {
            color: #059669; 
            border-color: #059669;
            font-weight: 600;
        }
        /* Ensure text hides cleanly when sidebar collapses */
        .nav-icon {
            transition: margin 0.3s ease;
        }
        /* Style for the dynamic pill/tag filter */
        .pill-active {
            background-color: #059669;
            color: white;
            box-shadow: 0 2px 4px rgba(5, 150, 105, 0.4);
        }
        .pill-active:hover {
            background-color: #047857;
        }
        
        /* FIX: Ensure sticky elements stack correctly */
        #product-tabs-header {
            top: 5rem; 
            z-index: 10; 
        }
        
        /* FIX: Adjusted top position for the main filter sidebar */
        .filter-sidebar-sticky {
            top: 15rem; /* Below header, tabs, and pill bar */
            z-index: 4;
        }
        #product-grid > #loading-products {
            grid-column: 1 / -1;
        }
        
        /* NEW: Pill Wrapper fixed position */
        #cut-pill-filter-bar-wrapper {
            top: 9.5rem; /* Below the tabs header */
            z-index: 9;
        }
        /* Style for star filter buttons */
        /* REMOVED gray background for rating pill */
        .rating-pill-button {
            transition: background-color 0.15s;
            border: 1px solid transparent;
        }
        .rating-pill-button:hover {
            border: 1px solid #d1fae5; /* subtle hover border */
        }
        .rating-active {
            /* Applied to the container for the selected rating to provide feedback */
            background-color: #fef3c7 !important; /* amber-100 */
            border-color: #fcd34d !important; /* amber-300 */
            font-weight: 600;
        }

        /* Custom Range Slider Styling (to simulate a joined slider) */
        .price-slider-wrapper {
            position: relative;
            height: 40px;
            padding-top: 15px;
        }
        .price-slider-wrapper input[type=range] {
            position: absolute;
            width: 100%;
            height: 5px;
            background: transparent;
            pointer-events: none; /* Allows clicks to pass through */
            -webkit-appearance: none;
        }
        /* FIX: Ensure slider thumbs are solid circles */
        .price-slider-wrapper input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--gmg-green);
            cursor: pointer;
            pointer-events: all;
            margin-top: -5px; /* Adjust based on track height */
        }
        .price-slider-wrapper .slider-track {
            position: absolute;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: #e5e7eb; /* Light grey track */
            top: 50%;
            transform: translateY(-50%);
        }
        .price-slider-wrapper .slider-range {
            position: absolute;
            height: 6px;
            background: var(--gmg-green);
            top: 50%;
            transform: translateY(-50%);
        }
        /* Ensure the two thumbs sit on top of each other */
        #range-max { z-index: 2; }
        #range-min { z-index: 3; }
        
        /* NEW: Micro-Interaction Styles */
        .add-to-cart-btn-animate {
            transition: transform 0.1s ease-out; /* Soft scale-up/down */
        }
        .button-clicked {
            transform: scale(0.95); /* Soft push effect */
        }
        
        .cart-highlight {
            animation: cart-bounce 0.5s ease-out;
        }
        @keyframes cart-bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white card-shadow sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                <span class="text-emerald-600 mr-2">GMG</span> Distributor Portal
            </h1>
            <div class="flex items-center space-x-4">
                <button id="cart-button" class="relative p-2 rounded-full hover:bg-gray-100 transition">
                    <i data-lucide="shopping-cart" class="w-6 h-6 text-gray-600"></i>
                    <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
                </button>
                <div id="user-info" class="text-sm font-medium text-gray-700">
                    Distributor ID: <span id="user-id-display" class="font-mono text-xs bg-gray-100 px-2 py-1 rounded-md">GMG-DIST-001</span>
                </div>
                <!-- Mobile Navigation Toggle -->
                <button id="mobile-nav-toggle" class="lg:hidden p-2 rounded-full hover:bg-gray-100 transition">
                    <i data-lucide="menu" class="w-6 h-6 text-gray-600"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area - Grid Layout -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- 1. Left Navigation Sidebar (lg:col-span-2) -->
        <!-- NOTE: Initial state is handled by JS in setupEventListeners() -->
        <div id="left-nav-sidebar" class="lg:col-span-2 hidden lg:block bg-white p-4 rounded-xl card-shadow h-fit sticky top-28 transition-all duration-300">
            <div class="flex justify-between items-center mb-3">
                <h3 id="sidebar-title" class="text-xs font-semibold uppercase text-gray-500 ml-3 transition-opacity duration-300">Menu</h3>
                <button id="sidebar-toggle-desktop" class="p-1 rounded-full text-gray-500 hover:bg-gray-100 transition">
                    <i data-lucide="chevron-left" id="toggle-icon" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div id="sidebar-content">
                <!-- Procure -->
                <button class="nav-tab w-full text-left p-3 rounded-lg text-sm font-medium transition active-nav-tab flex items-center" data-target="catalog-view">
                    <i data-lucide="layout-grid" class="nav-icon w-4 h-4 mr-2 transition-all duration-300"></i> <span class="sidebar-text transition-opacity duration-300 whitespace-nowrap">Procure</span>
                </button>
                
                <!-- Credit Line -->
                <button class="nav-tab w-full text-left p-3 rounded-lg text-sm font-medium transition text-gray-700 hover:bg-gray-100 mt-1 flex items-center" data-target="dashboard-view">
                    <i data-lucide="wallet" class="nav-icon w-4 h-4 mr-2 transition-all duration-300"></i> <span class="sidebar-text transition-opacity duration-300 whitespace-nowrap">Credit Line</span>
                </button>
                
                <!-- Orders -->
                <button class="nav-tab w-full text-left p-3 rounded-lg text-sm font-medium transition text-gray-700 hover:bg-gray-100 mt-1 flex items-center" data-target="dashboard-view">
                    <i data-lucide="package" class="nav-icon w-4 h-4 mr-2 transition-all duration-300"></i> <span class="sidebar-text transition-opacity duration-300 whitespace-nowrap">Orders</span>
                </button>
            </div>
        </div>

        <!-- Mobile Navigation Drawer -->
        <div id="mobile-nav-drawer" class="fixed inset-0 bg-white z-40 p-6 hidden lg:hidden">
             <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="text-xl font-bold text-gray-800">Navigation</h3>
                <button onclick="document.getElementById('mobile-nav-drawer').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <!-- Procure -->
            <button class="nav-tab mobile-nav-item w-full text-left p-3 rounded-lg text-lg font-medium transition active-nav-tab mb-2" data-target="catalog-view">
                <i data-lucide="layout-grid" class="w-5 h-5 mr-3 inline-block align-text-bottom"></i> Procure
            </button>
            <!-- Credit Line -->
            <button class="nav-tab mobile-nav-item w-full text-left p-3 rounded-lg text-lg font-medium transition text-gray-700 hover:bg-gray-100 mb-2" data-target="dashboard-view">
                <i data-lucide="wallet" class="w-5 h-5 mr-3 inline-block align-text-bottom"></i> Credit Line
            </button>
            <!-- Orders -->
            <button class="nav-tab mobile-nav-item w-full text-left p-3 rounded-lg text-lg font-medium transition text-gray-700 hover:bg-gray-100" data-target="dashboard-view">
                <i data-lucide="package" class="w-5 h-5 mr-3 inline-block align-text-bottom"></i> Orders
            </button>
        </div>
        
        <!-- 2. View Container (lg:col-span-10 / 12 for mobile) -->
        <div id="view-container" class="lg:col-span-10 col-span-12 transition-all duration-300">

            <!-- 1. Product Catalog View (Procure Product) - Now Tabbed & Grouped -->
            <div id="catalog-view" class="view">
                
                <!-- Product Tabs (Meat Type) -->
                <div id="product-tabs-header" class="flex flex-wrap border-b border-gray-200 bg-white p-3 rounded-xl card-shadow mb-6 sticky z-0">
                    <!-- Tabs will be dynamically injected here -->
                    <div class="text-gray-500 p-2">Loading product categories...</div>
                </div>

                <!-- NEW: Cut Pill/Tag Filter Bar with Scroll Buttons -->
                <div id="cut-pill-filter-bar-wrapper" class="bg-white p-3 rounded-xl card-shadow mb-6 sticky hidden sm:block z-10">
                    <div class="flex items-center">
                        <span class="text-sm font-semibold text-gray-600 mr-4 whitespace-nowrap hidden md:block">Filter by Cut:</span>
                        
                        <!-- Left Scroll Button -->
                        <button id="pill-scroll-left" onclick="scrollPills(-150)" disabled class="p-1 rounded-full text-gray-500 hover:bg-gray-200 transition disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>

                        <!-- Pill List Container (The actual scrolling element) -->
                        <div id="pill-list-container" class="flex-grow overflow-x-hidden">
                            <div id="pill-list-inner" class="flex space-x-2 py-1 whitespace-nowrap">
                                <!-- Pills will be injected here -->
                            </div>
                        </div>

                        <!-- Right Scroll Button -->
                        <button id="pill-scroll-right" onclick="scrollPills(150)" disabled class="p-1 rounded-full text-gray-500 hover:bg-gray-200 transition disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

                    <!-- Filter / Search Sidebar -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl card-shadow h-fit sticky filter-sidebar-sticky">
                        
                        <!-- Quick Search (RENAME: SKU/Name/Brand) -->
                        <div class="mb-6 border-b pb-4">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="search" class="w-5 h-5 mr-2 text-emerald-600"></i>
                                SKU/Name/Brand
                            </h2>
                            <!-- Removed redundant label -->
                            <input type="text" id="search-input" placeholder="Search within current type..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                        </div>

                        <!-- Price Range Filter -->
                        <div class="mb-6 border-b pb-4">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="dollar-sign" class="w-5 h-5 mr-2 text-emerald-600"></i>
                                Price Range
                            </h2>
                            <!-- Price Display (Right-aligned) -->
                            <div class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                                <span id="price-min-display" class="text-left w-1/2">AED 15</span>
                                <span id="price-max-display" class="text-right w-1/2">AED 850</span>
                            </div>

                            <!-- Dual Range Slider -->
                            <div class="price-slider-wrapper">
                                <div class="slider-track"></div>
                                <div id="slider-range-fill" class="slider-range"></div>

                                <input type="range" id="range-min" min="0" max="1000" value="0" 
                                       oninput="handleSliderChange(this.id)" 
                                       class="z-30">
                                <input type="range" id="range-max" min="0" max="1000" value="1000" 
                                       oninput="handleSliderChange(this.id)" 
                                       class="z-20">
                            </div>
                        </div>

                        <!-- Rating Filter (RENAME: Product Rating, FIX: Left Align Stars) -->
                        <div class="mb-4">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="star" class="w-5 h-5 mr-2 text-yellow-500 fill-yellow-500"></i>
                                Product Rating
                            </h2>
                            <div id="rating-filter-container" class="flex flex-col space-y-2">
                                <!-- Static HTML updated for left alignment -->
                                <button onclick="handleRatingChange(5.0)" data-rating="5.0" class="rating-pill-button w-full p-2 rounded-lg transition flex items-center justify-start hover:bg-gray-50">
                                    <div class="flex items-center space-x-1 ml-2">
                                        <i data-lucide="star" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>
                                        <i data-lucide="star" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>
                                        <i data-lucide="star" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>
                                        <i data-lucide="star" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>
                                        <i data-lucide="star" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>
                                    </div>
                                </button>
                                <button onclick="handleRatingChange(4.5)" data-rating="4.5" class="rating-pill-button w-full p-2 rounded-lg transition flex items-center justify-start hover:bg-gray-50">
                                    <div class="flex items-center space-x-1 ml-2">
                                        <i data-lucide="star" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>
                                        <i data-lucide="star" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>
                                        <i data-lucide="star" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>
                                        <i data-lucide="star" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>
                                        <i data-lucide="star-half" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>
                                    </div>
                                </button>
                                <button onclick="handleRatingChange(4.0)" data-rating="4.0" class="rating-pill-button w-full p-2 rounded-lg transition flex items-center justify-start hover:bg-gray-50">
                                    <div class="flex items-center space-x-1 ml-2">
                                        <i data-lucide="star" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>
                                        <i data-lucide="star" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>
                                        <i data-lucide="star" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>
                                        <i data-lucide="star" class="w-4 h-4 fill-yellow-500 text-yellow-500"></i>
                                        <i data-lucide="star" class="w-4 h-4 text-gray-300"></i>
                                    </div>
                                </button>
                                <button onclick="handleRatingChange(0)" data-rating="0" class="rating-pill-button w-full p-2 rounded-lg transition flex items-center justify-center text-gray-700 rating-active hover:bg-gray-50">
                                    All Products
                                </button>
                            </div>
                        </div>

                    </div>

                    <!-- Product Grid Container (Now holds sections) -->
                    <div class="lg:col-span-3">
                        
                        <!-- NEW SCROLLABLE BOX -->
                        <div id="product-scroll-box" class="max-h-[calc(100vh-18rem)] overflow-y-auto pr-2">
                            <div id="product-grid" class="space-y-8 pt-4"> 
                                <!-- Product sections (headings + grid) will be injected here -->
                                <div class="col-span-full text-center py-10 text-gray-500" id="loading-products">
                                    <i data-lucide="loader" class="w-8 h-8 mx-auto animate-spin text-emerald-500 mb-2"></i>
                                    Loading products...
                                </div>
                            </div>
                        </div>
                        <!-- NO PRODUCTS MESSAGE - kept outside scroll box so it's always in view if empty -->
                        <div id="no-products" class="hidden col-span-full text-center py-10 text-gray-500 text-lg font-medium">
                            No products match your current search criteria.
                        </div>

                    </div>

                </div>
            </div>

            <!-- 2. Distributor Dashboard View -->
            <div id="dashboard-view" class="view hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Financial Summary & Order Tracking</h2>

                <!-- CREDIT LINE OVERVIEW SECTION -->
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i data-lucide="wallet" class="w-5 h-5 mr-2 text-emerald-600"></i> Credit Line Overview
                </h3>

                <!-- Financial Card -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl card-shadow border-l-4 border-emerald-600">
                        <p class="text-sm font-medium text-gray-500">Total Credit Limit</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1" id="credit-limit">AED 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl card-shadow border-l-4 border-yellow-500">
                        <p class="text-sm font-medium text-gray-500">Outstanding Balance</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1" id="credit-used">AED 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl card-shadow border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Available Credit</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1" id="credit-available">AED 0</p>
                    </div>
                </div>

                <!-- Credit Utilization Bar -->
                <div class="bg-white p-6 rounded-xl card-shadow mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Credit Utilization</h3>
                    <div class="w-full bg-gray-200 rounded-full h-4 relative">
                        <div id="utilization-bar" class="bg-emerald-600 h-4 rounded-full" style="width: 0%"></div>
                        <span id="utilization-percent" class="absolute right-2 top-0.5 text-xs text-white font-semibold">0%</span>
                    </div>
                </div>
                
                <!-- ORDER TRACKING SECTION -->
                <h3 class="text-xl font-semibold text-gray-800 mb-4 mt-8 flex items-center">
                    <i data-lucide="package" class="w-5 h-5 mr-2 text-emerald-600"></i> Recent Orders and Tracking
                </h3>

                <!-- Order History Table -->
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Value</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Track</th>
                                </tr>
                            </thead>
                            <tbody id="order-history-body" class="bg-white divide-y divide-gray-200">
                                <!-- Orders will be injected here -->
                                <tr>
                                    <td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No orders placed yet.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl w-full max-w-lg card-shadow">
                <!-- Modal Header -->
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center"><i data-lucide="shopping-cart" class="w-5 h-5 mr-2"></i> Shopping Cart</h3>
                    <button onclick="closeModal('cart-modal')" class="text-gray-400 hover:text-gray-600 transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <!-- Modal Body -->
                <div class="p-6 scroll-area">
                    <div id="cart-items-container">
                        <p id="empty-cart-message" class="text-gray-500 text-center py-4 hidden">Your cart is empty. Add some products!</p>
                        <!-- Cart items will be injected here -->
                    </div>
                </div>
                <!-- Modal Footer -->
                <div class="p-6 border-t">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-semibold text-gray-700">Subtotal:</span>
                        <span id="cart-subtotal" class="text-xl font-bold text-emerald-600">AED 0</span>
                    </div>
                    <button id="place-order-button" onclick="placeOrder()" class="w-full bg-emerald-600 text-white p-3 rounded-lg hover:bg-emerald-700 transition font-bold disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Place Order
                    </button>
                    <p id="credit-warning" class="text-red-500 text-sm mt-2 hidden text-center font-medium">Order total exceeds available credit line!</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Product Detail Modal -->
    <div id="product-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl w-full max-w-2xl card-shadow">
                <!-- Modal Header -->
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 id="detail-modal-title" class="text-xl font-bold text-gray-800">Product Details</h3>
                    <button onclick="closeModal('product-detail-modal')" class="text-gray-400 hover:text-gray-600 transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <!-- Modal Body -->
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Image and Basic Info -->
                    <div class="md:col-span-1">
                        <img id="detail-image" src="" alt="Product Image" class="w-full h-auto rounded-lg object-cover border border-gray-100 mb-4" onerror="this.onerror=null;this.src='https://placehold.co/100x100/A7F3D0/047857?text=No+Image';">
                        <p class="text-sm text-gray-500">SKU: <span id="detail-sku" class="font-medium text-gray-700"></span></p>
                        <p class="text-sm text-gray-500">Brand: <span id="detail-brand" class="font-medium text-gray-700"></span></p>
                        <p class="text-sm text-gray-500">Inventory: <span id="detail-inventory" class="font-medium text-gray-700"></span></p>
                    </div>

                    <!-- Price, Rating, and Description -->
                    <div class="md:col-span-1">
                        <p class="text-3xl font-extrabold text-emerald-700 mb-2">
                            <span id="detail-price"></span> 
                            <span id="detail-unit" class="text-lg font-normal text-gray-500"></span>
                        </p>
                        <div id="detail-rating" class="mb-4"></div>
                        
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-1 mb-2">Description</h4>
                        <p id="detail-description" class="text-gray-600 text-sm"></p>
                        
                        <!-- Add to Cart controls -->
                        <div class="mt-6 pt-4 border-t">
                            <h4 class="text-md font-semibold text-gray-800 mb-2">Order Quantity</h4>
                            <div class="flex items-center space-x-2">
                                <button id="detail-minus-btn" class="p-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50 transition">
                                    <i data-lucide="minus" class="w-4 h-4"></i>
                                </button>
                                <input type="number" id="detail-qty-input" value="1" min="1" class="font-medium text-lg w-16 text-center border rounded-lg p-1.5 focus:ring-emerald-500 focus:border-emerald-500">
                                <button id="detail-plus-btn" class="p-1.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <button id="detail-add-to-cart-btn" class="w-full bg-emerald-600 text-white p-3 rounded-lg hover:bg-emerald-700 transition font-bold mt-4 add-to-cart-btn-animate">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl w-full max-w-sm card-shadow p-6 text-center">
                <h3 id="message-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
                <p id="message-body" class="text-gray-600 mb-6"></p>
                <button onclick="closeModal('message-modal')" class="bg-emerald-600 text-white p-2 w-full rounded-lg hover:bg-emerald-700 transition font-semibold">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Application Logic (No Firebase) -->
    <script type="module">
        // --- GLOBAL STATE ---
        const MOCK_USER_ID = 'GMG-DIST-001';
        
        window.cart = {}; // Global cart object
        
        // Initial Mock Data Setup (Used instead of loading from Firebase)
        const defaultImageUrl = "https://placehold.co/100x100/34D399/FFFFFF/png?text=GMG+Meat";
        
        // EXPANDED PRODUCT LIST (50+ SKUS) - Sourced from Farm Fresh examples
        window.products = [
            // === BEEF (20 SKUs) ===
            { id: 'prod1', sku: 'BEEF-RIBEYE-AAA-10KG', name: 'AAA Beef Ribeye Steak (Frozen)', brand: 'GMG Select', type: 'Beef', cut: 'Steak', unit: 'kg', unitPrice: 850.00, inventory: 50, imageUrl: defaultImageUrl, rating: 4.8, description: "Highly marbled, tender Ribeye steak, flash-frozen. Ideal for high-end restaurants." },
            { id: 'prod4', sku: 'BEEF-TENDER-WAG-1KG', name: 'Wagyu Beef Tenderloin A5', brand: 'Kobe Reserve', type: 'Beef', cut: 'Tenderloin', unit: 'g', unitPrice: 15.00, inventory: 20, imageUrl: defaultImageUrl, rating: 5.0, description: "The pinnacle of beef quality. Genuine A5 Wagyu Tenderloin." },
            { id: 'prod6', sku: 'BEEF-MINCE-REG-5KG', name: 'Regular Ground Beef Mince (80/20)', brand: 'GMG Select', type: 'Beef', cut: 'Mince', unit: 'kg', unitPrice: 350.00, inventory: 150, imageUrl: defaultImageUrl, rating: 4.1, description: "Standard 80% lean, 20% fat ground beef blend. Versatile for burgers and meatballs." },
            { id: 'prod9', sku: 'BEEF-FILLET-WHL-5KG', name: 'Whole Beef Fillet Muscle (Frozen)', brand: 'GMG Select', type: 'Beef', cut: 'Loin', unit: 'box', unitPrice: 700.00, inventory: 40, imageUrl: defaultImageUrl, rating: 4.9, description: "Whole frozen beef fillet, suitable for slicing into filet mignon or chateaubriand." },
            { id: 'prod10', sku: 'BEEF-SIRLOIN-CHLD-1KG', name: 'Chilled AAA Sirloin Steak', brand: 'Prime Cut', type: 'Beef', cut: 'Steak', unit: 'kg', unitPrice: 55.00, inventory: 110, imageUrl: defaultImageUrl, rating: 4.5, description: "AAA Sirloin, great balance of flavor and tenderness. Sold as individual 1kg pieces." },
            { id: 'prod11', sku: 'BEEF-SHORTS-BONE-15KG', name: 'Premium Short Ribs (Bone-in)', brand: 'GMG Select', type: 'Beef', cut: 'Ribs', unit: 'box', unitPrice: 650.00, inventory: 35, imageUrl: defaultImageUrl, rating: 4.7, description: "Thick, meaty bone-in short ribs, perfect for slow cooking and smoking." },
            { id: 'prod12', sku: 'BEEF-BRISKET-FLT-5KG', name: 'Beef Brisket Flat Cut (Frozen)', brand: 'Smokehouse', type: 'Beef', cut: 'Roast', unit: 'kg', unitPrice: 380.00, inventory: 85, imageUrl: defaultImageUrl, rating: 4.6, description: "Select Beef Brisket flat cut, ideal for slicing or corned beef preparation." },
            { id: 'prod13', sku: 'BEEF-DICED-STEW-1KG', name: 'Diced Beef Cubes (Stewing Grade)', brand: 'ValuePak', type: 'Beef', cut: 'Cube', unit: 'kg', unitPrice: 45.00, inventory: 160, imageUrl: defaultImageUrl, rating: 3.8, description: "Economical diced beef pieces for curries and slow-cooked stews." },
            { id: 'prod14', sku: 'BEEF-MINCE-LEAN-5KG', name: 'Lean Ground Beef Mince (90/10)', brand: 'GMG Select', type: 'Beef', cut: 'Mince', unit: 'kg', unitPrice: 420.00, inventory: 95, imageUrl: defaultImageUrl, rating: 4.3, description: "Extra lean ground beef blend for lighter meals." },
            { id: 'prod15', sku: 'BEEF-OXT-WHL-1KG', name: 'Whole Beef Oxtail (Frozen)', brand: 'Prime Cut', type: 'Beef', cut: 'Bone', unit: 'kg', unitPrice: 75.00, inventory: 40, imageUrl: defaultImageUrl, rating: 4.0, description: "Frozen whole beef oxtail, great for soups and rich gravy." },
            { id: 'prod16', sku: 'BEEF-FLANK-FRZ-5KG', name: 'Frozen Flank Steak Muscle', brand: 'Prime Cut', type: 'Beef', cut: 'Steak', unit: 'kg', unitPrice: 410.00, inventory: 60, imageUrl: defaultImageUrl, rating: 4.4, description: "Flank steak, excellent for marinades and grilling, packed in 5kg portions." },
            { id: 'prod17', sku: 'BEEF-ROAST-RND-2KG', name: 'Chilled Round Roast', brand: 'GMG Select', type: 'Beef', cut: 'Roast', unit: 'kg', unitPrice: 110.00, inventory: 70, imageUrl: defaultImageUrl, rating: 4.2, description: "Lean and flavorful Round Roast, excellent value for traditional roasting." },
            { id: 'prod18', sku: 'BEEF-T-BONE-FRZ-1KG', name: 'T-Bone Steak (Frozen)', brand: 'Butcher Block', type: 'Beef', cut: 'Steak', unit: 'piece', unitPrice: 75.00, inventory: 90, imageUrl: defaultImageUrl, rating: 4.5, description: "Individually packed, bone-in T-Bone steak." },
            { id: 'prod19', sku: 'BEEF-SKIRT-PRM-1KG', name: 'Premium Skirt Steak (Outside)', brand: 'Prime Cut', type: 'Beef', cut: 'Steak', unit: 'kg', unitPrice: 95.00, inventory: 55, imageUrl: defaultImageUrl, rating: 4.7, description: "Outside skirt steak, ideal for fajitas and quick grilling." },
            { id: 'prod20', sku: 'BEEF-DICED-PRM-5KG', name: 'Premium Beef Cubes (Chilled)', brand: 'GMG Select', type: 'Beef', cut: 'Cube', unit: 'kg', unitPrice: 320.00, inventory: 80, imageUrl: defaultImageUrl, rating: 4.5, description: "High-quality chilled beef cubes, excellent for goulash or high-end stews." },
            { id: 'prod21', sku: 'BEEF-MARROW-1KG', name: 'Beef Marrow Bones', brand: 'ValuePak', type: 'Beef', cut: 'Bone', unit: 'kg', unitPrice: 25.00, inventory: 150, imageUrl: defaultImageUrl, rating: 4.0, description: "Assorted marrow bones for broth and stock making." },
            { id: 'prod22', sku: 'BEEF-CUBE-KABOB-5KG', name: 'Beef Kabob Cubes', brand: 'GMG Select', type: 'Beef', cut: 'Cube', unit: 'kg', unitPrice: 340.00, inventory: 70, imageUrl: defaultImageUrl, rating: 4.3, description: "Uniformly cut cubes, perfect for skewers and grilling." },
            { id: 'prod23', sku: 'BEEF-RIB-EYE-SLIC-1KG', name: 'Sliced Beef Ribeye (Shabu)', brand: 'Prime Cut', type: 'Beef', cut: 'Slice', unit: 'g', unitPrice: 12.00, inventory: 40, imageUrl: defaultImageUrl, rating: 4.9, description: "Thinly sliced Ribeye for hot pot or quick cooking." },
            { id: 'prod56', sku: 'BEEF-PATTIES-QTR-1KG', name: 'Quarter Pound Beef Patties (8x 125g)', brand: 'ChefPro', type: 'Beef', cut: 'Patties', unit: 'pack', unitPrice: 65.00, inventory: 200, imageUrl: defaultImageUrl, rating: 4.5, description: "Frozen, ready-to-cook quarter pounder beef patties." },
            { id: 'prod57', sku: 'BEEF-RUMP-FRZ-5KG', name: 'Beef Rump Steak Muscle (Frozen)', brand: 'Prime Cut', type: 'Beef', cut: 'Steak', unit: 'kg', unitPrice: 450.00, inventory: 55, imageUrl: defaultImageUrl, rating: 4.6, description: "Large frozen rump steak muscle for roasting or steak preparation." },

            // === LAMB (15 SKUs) ===
            { id: 'prod2', sku: 'LAMB-LOIN-CHLD-5KG', name: 'Chilled Australian Lamb Loin', brand: 'Down Under', type: 'Lamb', cut: 'Loin', unit: 'kg', unitPrice: 520.00, inventory: 80, imageUrl: defaultImageUrl, rating: 4.5, description: "Prime grade, chilled lamb loin, perfect for carving." },
            { id: 'prod5', sku: 'LAMB-SHANK-FRZ-10KG', name: 'Frozen New Zealand Lamb Shank', brand: 'Down Under', type: 'Lamb', cut: 'Shank', unit: 'box', unitPrice: 480.00, inventory: 65, imageUrl: defaultImageUrl, rating: 3.9, description: "Classic New Zealand lamb shanks, excellent for slow cooking." },
            { id: 'prod8', sku: 'LAMB-CUBE-CHLD-1KG', name: 'Chilled Lamb Diced Cubes', brand: 'Down Under', type: 'Lamb', cut: 'Cube', unit: 'kg', unitPrice: 400.00, inventory: 90, imageUrl: defaultImageUrl, rating: 4.7, description: "Pre-diced, chilled lamb cubes ready for kebabs or curries." },
            { id: 'prod24', sku: 'LAMB-RACK-FRZ-1KG', name: 'French Trimmed Lamb Rack (Frozen)', brand: 'Prime Cut', type: 'Lamb', cut: 'Rack', unit: 'piece', unitPrice: 95.00, inventory: 50, imageUrl: defaultImageUrl, rating: 4.9, description: "Individually frozen, French trimmed lamb rack, perfect for fine dining." },
            { id: 'prod25', sku: 'LAMB-MINCE-REG-5KG', name: 'Ground Lamb Mince (80/20)', brand: 'Down Under', type: 'Lamb', cut: 'Mince', unit: 'kg', unitPrice: 380.00, inventory: 110, imageUrl: defaultImageUrl, rating: 4.3, description: "Flavorsome ground lamb blend, ideal for kofta and savory pies." },
            { id: 'prod26', sku: 'LAMB-LEG-BONL-2KG', name: 'Boneless Lamb Leg Roast', brand: 'GMG Select', type: 'Lamb', cut: 'Roast', unit: 'kg', unitPrice: 150.00, inventory: 75, imageUrl: defaultImageUrl, rating: 4.6, description: "Easy-to-carve boneless lamb leg roast, great for catering." },
            { id: 'prod27', sku: 'LAMB-CHOP-LOIN-1KG', name: 'Lamb Loin Chops (Chilled)', brand: 'Butcher Block', type: 'Lamb', cut: 'Chop', unit: 'kg', unitPrice: 85.00, inventory: 60, imageUrl: defaultImageUrl, rating: 4.4, description: "Thick-cut loin chops, ready for grilling or pan-searing." },
            { id: 'prod28', sku: 'LAMB-SHOULDER-DICE-5KG', name: 'Lamb Shoulder Diced (Frozen)', brand: 'ValuePak', type: 'Lamb', cut: 'Cube', unit: 'kg', unitPrice: 350.00, inventory: 130, imageUrl: defaultImageUrl, rating: 3.7, description: "Cost-effective diced lamb shoulder for large volume use." },
            { id: 'prod29', sku: 'LAMB-NECK-SLICE-1KG', name: 'Lamb Neck Slices (Frozen)', brand: 'Down Under', type: 'Lamb', cut: 'Slice', unit: 'kg', unitPrice: 55.00, inventory: 45, imageUrl: defaultImageUrl, rating: 4.0, description: "Cross-cut lamb neck for robust stews and stock." },
            { id: 'prod30', sku: 'LAMB-SAUS-PRM-1KG', name: 'Premium Lamb Sausages (Chilled)', brand: 'Butcher Block', type: 'Lamb', cut: 'Sausage', unit: 'pack', unitPrice: 40.00, inventory: 90, imageUrl: defaultImageUrl, rating: 4.3, description: "Gourmet lamb sausages with mint and rosemary seasoning." },
            { id: 'prod31', sku: 'LAMB-BONES-STOCK-5KG', name: 'Lamb Bones for Stock', brand: 'ValuePak', type: 'Lamb', cut: 'Bone', unit: 'kg', unitPrice: 15.00, inventory: 180, imageUrl: defaultImageUrl, rating: 3.5, description: "Assorted lamb bones for making rich, savory stock." },
            { id: 'prod32', sku: 'LAMB-KABOB-PRM-1KG', name: 'Lamb Kabob Skewers', brand: 'Prime Cut', type: 'Lamb', cut: 'Cube', unit: 'piece', unitPrice: 8.00, inventory: 120, imageUrl: defaultImageUrl, rating: 4.6, description: "Pre-marinated lamb cubes on skewers, ready for the grill." },
            { id: 'prod33', sku: 'LAMB-RIB-BREAST-10KG', name: 'Lamb Rib and Breast Flaps', brand: 'ValuePak', type: 'Lamb', cut: 'Ribs', unit: 'box', unitPrice: 350.00, inventory: 55, imageUrl: defaultImageUrl, rating: 3.8, description: "Economical lamb ribs and breast flaps for value cooking." },
            { id: 'prod34', sku: 'LAMB-FILLET-SLCT-1KG', name: 'Selected Lamb Fillet Muscle', brand: 'GMG Select', type: 'Lamb', cut: 'Loin', unit: 'kg', unitPrice: 120.00, inventory: 40, imageUrl: defaultImageUrl, rating: 4.7, description: "Lean and tender whole lamb fillet, great for quick cooking." },
            { id: 'prod58', sku: 'LAMB-STEW-BONE-1KG', name: 'Lamb Stew Meat (Bone-in)', brand: 'Butcher Block', type: 'Lamb', cut: 'Stew', unit: 'kg', unitPrice: 65.00, inventory: 70, imageUrl: defaultImageUrl, rating: 4.1, description: "Bone-in lamb pieces ideal for making hearty, rich stews." },

            // === CHICKEN (15 SKUs) ===
            { id: 'prod3', sku: 'CHICKEN-MINCE-1KG', name: 'Bulk Ground Chicken Breast (Chilled)', brand: 'PoultryPro', type: 'Chicken', cut: 'Mince', unit: 'kg', unitPrice: 85.00, inventory: 120, imageUrl: defaultImageUrl, rating: 4.2, description: "Lean ground chicken breast, suitable for health-conscious menus." },
            { id: 'prod7', sku: 'CHICKEN-THIGH-BONE-1KG', name: 'Frozen Chicken Thighs (Bone-in)', brand: 'PoultryPro', type: 'Chicken', cut: 'Thigh', unit: 'piece', unitPrice: 2.50, inventory: 8, imageUrl: defaultImageUrl, rating: 4.6, description: "Individually frozen, bone-in chicken thighs. A cost-effective and flavorful option." }, 
            { id: 'prod35', sku: 'CHICKEN-BRST-BONL-2KG', name: 'Boneless Chicken Breast Fillet', brand: 'GMG Select', type: 'Chicken', cut: 'Breast', unit: 'kg', unitPrice: 15.00, inventory: 300, imageUrl: defaultImageUrl, rating: 4.9, description: "High-quality boneless, skinless chicken breast fillet. Frozen IQF." },
            { id: 'prod36', sku: 'CHICKEN-WINGS-BULK-5KG', name: 'Chicken Wings (3-Joint, Bulk)', brand: 'ValuePak', type: 'Chicken', cut: 'Wing', unit: 'box', unitPrice: 120.00, inventory: 180, imageUrl: defaultImageUrl, rating: 4.0, description: "Bulk box of 3-joint chicken wings, great for appetizers." },
            { id: 'prod37', sku: 'CHICKEN-DRUM-CHLD-1KG', name: 'Chilled Chicken Drumsticks', brand: 'PoultryPro', type: 'Chicken', cut: 'Leg', unit: 'kg', unitPrice: 8.00, inventory: 250, imageUrl: defaultImageUrl, rating: 4.3, description: "Fresh, chilled chicken drumsticks, excellent for frying or baking." },
            { id: 'prod38', sku: 'CHICKEN-WHOLE-1KG', name: 'Whole Chicken (1kg avg)', brand: 'PoultryPro', type: 'Chicken', cut: 'Whole', unit: 'piece', unitPrice: 12.00, inventory: 90, imageUrl: defaultImageUrl, rating: 4.4, description: "Whole chicken, ideal for roasting or rotisserie." },
            { id: 'prod39', sku: 'CHICKEN-MINCE-PRM-1KG', name: 'Premium Chicken Mince (Lean)', brand: 'GMG Select', type: 'Chicken', cut: 'Mince', unit: 'kg', unitPrice: 90.00, inventory: 100, imageUrl: defaultImageUrl, rating: 4.5, description: "Very lean, high-quality chicken mince, vacuum sealed." },
            { id: 'prod40', sku: 'CHICKEN-LEGS-FRZ-10KG', name: 'Frozen Chicken Leg Quarters', brand: 'ValuePak', type: 'Chicken', cut: 'Leg', unit: 'box', unitPrice: 150.00, inventory: 60, imageUrl: defaultImageUrl, rating: 3.9, description: "Bulk frozen leg quarters, budget-friendly option." },
            { id: 'prod41', sku: 'CHICKEN-TENDERS-1KG', name: 'Chicken Breast Tenders (IQF)', brand: 'PoultryPro', type: 'Chicken', cut: 'Breast', unit: 'kg', unitPrice: 18.00, inventory: 150, imageUrl: defaultImageUrl, rating: 4.7, description: "Individually Quick Frozen (IQF) tenders, easy to thaw and cook." },
            { id: 'prod42', sku: 'CHICKEN-FEET-BULK-5KG', name: 'Chicken Feet (Bulk)', brand: 'ValuePak', type: 'Chicken', cut: 'Bone', unit: 'kg', unitPrice: 5.00, inventory: 200, imageUrl: defaultImageUrl, rating: 3.5, description: "For stock or specialized cuisine." },
            { id: 'prod43', sku: 'CHICKEN-CUBE-1KG', name: 'Chicken Breast Cubes (Chilled)', brand: 'GMG Select', type: 'Chicken', cut: 'Cube', unit: 'kg', unitPrice: 17.00, inventory: 130, imageUrl: defaultImageUrl, rating: 4.3, description: "Pre-cut chicken breast cubes, perfect for stir-fry." },
            { id: 'prod44', sku: 'CHICKEN-BACKS-5KG', name: 'Chicken Backs for Stock', brand: 'ValuePak', type: 'Chicken', cut: 'Bone', unit: 'kg', unitPrice: 6.00, inventory: 170, imageUrl: defaultImageUrl, rating: 3.6, description: "Used primarily for chicken stock base." },
            { id: 'prod45', sku: 'CHICKEN-THIGH-BONL-2KG', name: 'Boneless Chicken Thigh (Skin On)', brand: 'Prime Cut', type: 'Chicken', cut: 'Thigh', unit: 'kg', unitPrice: 16.00, inventory: 110, imageUrl: defaultImageUrl, rating: 4.5, description: "Boneless thigh with skin for maximum flavor when roasting." },
            { id: 'prod46', sku: 'CHICKEN-STRIP-1KG', name: 'Chicken Breast Strips (Chilled)', brand: 'PoultryPro', type: 'Chicken', cut: 'Breast', unit: 'kg', unitPrice: 14.50, inventory: 160, imageUrl: defaultImageUrl, rating: 4.4, description: "Pre-sliced strips, ready for salads and wraps." },
            { id: 'prod59', sku: 'CHICKEN-GRILLERS-1KG', name: 'Whole Chicken Grillers (Size 8)', brand: 'PoultryPro', type: 'Chicken', cut: 'Whole', unit: 'piece', unitPrice: 15.00, inventory: 80, imageUrl: defaultImageUrl, rating: 4.5, description: "Smaller whole chicken, ideal for grilling or single-serve roasting." },

            // === PROCESSED (11 SKUs) ===
            { id: 'prod60', sku: 'BURG-WAGYU-125G-PACK', name: 'Wagyu Beef Burger Patties (4-pack)', brand: 'ChefPro', type: 'Processed', cut: 'Patties', unit: 'pack', unitPrice: 95.00, inventory: 70, imageUrl: defaultImageUrl, rating: 4.9, description: "Premium 125g Wagyu beef burgers, quick frozen." },
            { id: 'prod61', sku: 'BURG-ANGUS-150G-PACK', name: 'Angus Beef Burger Patties (6-pack)', brand: 'ChefPro', type: 'Processed', cut: 'Patties', unit: 'pack', unitPrice: 80.00, inventory: 100, imageUrl: defaultImageUrl, rating: 4.6, description: "150g Angus beef patties, excellent for gourmet burgers." },
            { id: 'prod62', sku: 'SAUS-CHICKEN-JUMBO', name: 'Jumbo Chicken Grill Sausage (German Style)', brand: 'ChefPro', type: 'Processed', cut: 'Sausage', unit: 'pack', unitPrice: 45.00, inventory: 150, imageUrl: defaultImageUrl, rating: 4.4, description: "Thick, German-style chicken sausages, great for BBQs." },
            { id: 'prod63', sku: 'SAUS-BEEF-SMOKED', name: 'Jumbo Smoked Beef Sausage', brand: 'ChefPro', type: 'Processed', cut: 'Sausage', unit: 'pack', unitPrice: 50.00, inventory: 120, imageUrl: defaultImageUrl, rating: 4.5, description: "Smoked beef sausages, fully cooked and ready to heat." },
            { id: 'prod64', sku: 'SAUS-BEEF-SPICY', name: 'Jumbo Spicy Beef Sausage', brand: 'ChefPro', type: 'Processed', cut: 'Sausage', unit: 'pack', unitPrice: 52.00, inventory: 90, imageUrl: defaultImageUrl, rating: 4.3, description: "Spicy beef sausages with chili flakes." },
            { id: 'prod65', sku: 'SAUS-CHICKEN-CHILLI', name: 'Chicken Chilli Cheese Sausage', brand: 'ChefPro', type: 'Processed', cut: 'Sausage', unit: 'pack', unitPrice: 55.00, inventory: 80, imageUrl: defaultImageUrl, rating: 4.6, description: "Chicken sausages filled with cheese and chili." },
            { id: 'prod66', sku: 'DELI-BACON-BEEF-5KG', name: 'Beef Bacon Rashers (Bulk)', brand: 'Butcher Block', type: 'Processed', cut: 'Deli', unit: 'kg', unitPrice: 150.00, inventory: 60, imageUrl: defaultImageUrl, rating: 4.1, description: "Thinly sliced, premium beef bacon, perfect for breakfast." },
            { id: 'prod67', sku: 'DELI-SALAMI-CALA-1KG', name: 'Artisan Salami Calabrese', brand: 'Butcher Block', type: 'Processed', cut: 'Deli', unit: 'piece', unitPrice: 65.00, inventory: 40, imageUrl: defaultImageUrl, rating: 4.8, description: "Authentic dried salami, ready to slice." },
            { id: 'prod68', sku: 'DELI-BILTONG-BEEF', name: 'Beef Biltong Strips (Spicy)', brand: 'Butcher Block', type: 'Processed', cut: 'Deli', unit: 'pack', unitPrice: 75.00, inventory: 110, imageUrl: defaultImageUrl, rating: 4.7, description: "South African style dried beef strips, high protein snack." },
            { id: 'prod69', sku: 'DELI-HAM-BEEF-1KG', name: 'Premium Smoked Beef Ham', brand: 'GMG Select', type: 'Processed', cut: 'Deli', unit: 'kg', unitPrice: 120.00, inventory: 50, imageUrl: defaultImageUrl, rating: 4.4, description: "Whole muscle cooked and smoked beef ham, ideal for slicing." },
            { id: 'prod70', sku: 'PORK-FRANKS-ORIG-5KG', name: 'Pork Franks - Original', brand: 'ChefPro', type: 'Processed', cut: 'Sausage', unit: 'kg', unitPrice: 190.00, inventory: 75, imageUrl: defaultImageUrl, rating: 4.2, description: "Classic pork frankfurters, perfect for hotdogs." },

            // === PORK (4 SKUs) ===
            { id: 'prod47', sku: 'PORK-BELLY-SKN-2KG', name: 'Pork Belly Slab (Skin-on)', brand: 'Butcher Block', type: 'Pork', cut: 'Belly', unit: 'kg', unitPrice: 45.00, inventory: 60, imageUrl: defaultImageUrl, rating: 4.7, description: "Thick slab of pork belly, excellent for roasting or curing." },
            { id: 'prod48', sku: 'PORK-RIBS-SPARE-5KG', name: 'Spare Ribs (Frozen)', brand: 'Smokehouse', type: 'Pork', cut: 'Ribs', unit: 'box', unitPrice: 280.00, inventory: 45, imageUrl: defaultImageUrl, rating: 4.5, description: "Frozen spare ribs, great for BBQ and smoking." },
            { id: 'prod49', sku: 'PORK-LOIN-BONL-2KG', name: 'Boneless Pork Loin', brand: 'GMG Select', type: 'Pork', cut: 'Loin', unit: 'kg', unitPrice: 35.00, inventory: 70, imageUrl: defaultImageUrl, rating: 4.6, description: "Lean boneless pork loin, perfect for slicing or roasting." },
            { id: 'prod50', sku: 'PORK-DICED-1KG', name: 'Diced Pork Shoulder', brand: 'ValuePak', type: 'Pork', cut: 'Cube', unit: 'kg', unitPrice: 28.00, inventory: 100, imageUrl: defaultImageUrl, rating: 4.1, description: "Diced pork shoulder, ideal for stews, stir-fries, and kebab meat." },
            
            // === SEAFOOD (5 SKUs) ===
            { id: 'prod51', sku: 'FISH-SALMON-FILET-1KG', name: 'Atlantic Salmon Fillets (Skin On)', brand: 'AquaFresh', type: 'Seafood', cut: 'Fillet', unit: 'kg', unitPrice: 110.00, inventory: 90, imageUrl: defaultImageUrl, rating: 4.9, description: "Premium farmed Atlantic Salmon fillets, individually vacuum sealed." },
            { id: 'prod52', sku: 'SHRIMP-BLK-TIGER-1KG', name: 'Black Tiger Shrimp (26/30)', brand: 'OceanGold', type: 'Seafood', cut: 'Shellfish', unit: 'kg', unitPrice: 95.00, inventory: 120, imageUrl: defaultImageUrl, rating: 4.7, description: "26/30 count per kg, tail-on, peeled and deveined." },
            { id: 'prod53', sku: 'FISH-COD-PORTION-5KG', name: 'Cod Portions (Frozen Block)', brand: 'Northern Catch', type: 'Seafood', cut: 'Fillet', unit: 'box', unitPrice: 400.00, inventory: 50, imageUrl: defaultImageUrl, rating: 4.3, description: "5kg block of frozen, skinless, boneless cod portions." },
            { id: 'prod54', sku: 'MUSSELS-GREEN-1KG', name: 'New Zealand Green Lip Mussels', brand: 'Down Under', type: 'Seafood', cut: 'Shellfish', unit: 'kg', unitPrice: 35.00, inventory: 75, imageUrl: defaultImageUrl, rating: 4.6, description: "Frozen half-shell mussels, perfect for steaming." },
            { id: 'prod55', sku: 'SQUID-RINGS-FRZ-1KG', name: 'Frozen Squid Rings (IQF)', brand: 'OceanGold', type: 'Seafood', cut: 'Other', unit: 'kg', unitPrice: 45.00, inventory: 110, imageUrl: defaultImageUrl, rating: 4.0, description: "IQF calamari rings, ready for frying." },
        ];
        
        window.distributorProfile = {
            creditLimit: 250000,
            outstandingBalance: 5680.00, // Updated initial balance based on new mock orders
        };

        // Static helper function to generate mock order IDs
        const generateMockOrderId = () => 'ORD-' + Math.random().toString(36).substring(2, 10).toUpperCase();

        // Initial mock order data (Referencing expanded products)
        window.orders = [
            // Delivered Order - Uses prod1 (Beef Ribeye) and prod35 (Chicken Breast)
            { id: generateMockOrderId(), items: [{id:'prod1', quantity: 2, unit: 'kg'}, {id:'prod35', quantity: 10, unit: 'kg'}], totalAmount: 1850.00, status: 'Delivered', timestamp: new Date(Date.now() - 86400000 * 5) },
            // Shipped Order - Uses prod11 (Beef Ribs)
            { id: generateMockOrderId(), items: [{id:'prod11', quantity: 3, unit: 'box'}], totalAmount: 1950.00, status: 'Shipped', timestamp: new Date(Date.now() - 86400000 * 2) },
            // Processing Order - Uses prod4 (Wagyu Tenderloin) and prod25 (Lamb Mince)
            { id: generateMockOrderId(), items: [{id:'prod4', quantity: 100, unit: 'g'}, {id:'prod25', quantity: 5, unit: 'kg'}], totalAmount: 1880.00, status: 'Processing', timestamp: new Date() }
        ];

        // Global state for active filters
        window.activeFilters = {
            search: '',
            cut: [], 
            minRating: 0, 
            minPrice: null, 
            maxPrice: null  
        };
        
        // State
        // FIX: Set default tab to 'Processed'
        window.activeTab = 'Processed'; 
        // FIX: Set sidebar to collapsed true
        let isSidebarCollapsed = true;

        // Function to show custom message modal
        window.showMessage = (title, body) => {
            const titleEl = document.getElementById('message-title');
            const bodyEl = document.getElementById('message-body');
            const modalEl = document.getElementById('message-modal');

            if (titleEl) titleEl.textContent = title;
            if (bodyEl) bodyEl.textContent = body;
            if (modalEl) modalEl.classList.remove('hidden');
        };

        // Function to close any modal
        window.closeModal = (id) => {
            const modal = document.getElementById(id);
            if(modal) modal.classList.add('hidden');
        };

        // Utility: Format currency (FIX: Removed decimals)
        const formatCurrency = (amount) => {
            return `AED ${Math.round(parseFloat(amount)).toLocaleString('en-US')}`;
        };
        
        // Utility: Calculate min/max price bounds from current product list
        const getPriceBounds = () => {
            if (window.products.length === 0) return { min: 0, max: 1000 };
            const prices = window.products.map(p => p.unitPrice);
            const min = Math.floor(Math.min(...prices));
            const max = Math.ceil(Math.max(...prices));
            // Ensure a reasonable max range for the slider UI
            return { min: min, max: Math.max(1000, max) };
        };


        // --- MOCK DATA INITIALIZATION (Synchronous) ---
        const initializeApplicationData = () => {
            // FIX: Call toggleSidebar immediately to collapse the menu
            if (isSidebarCollapsed) {
                 // Call toggleSidebar once to go from HTML default (expanded) to collapsed state
                 toggleSidebar();
            }
            
            renderProductTabs();
            renderDashboard();
            
            // Initialize the Price Slider based on product bounds
            initializePriceSlider();
            
            const loadingEl = document.getElementById('loading-products');
            if (loadingEl) {
                loadingEl.classList.add('hidden');
            }
        };

        // --- TAB & FILTER UX LOGIC ---

        // Renders the Meat Type tabs
        const renderProductTabs = () => {
            if (window.products.length === 0) return;

            // Sort tabs alphabetically, but move 'Processed' to the start for default view
            let uniqueTypes = [...new Set(window.products.map(p => p.type))].sort();
            const processedIndex = uniqueTypes.indexOf('Processed');
            if (processedIndex > -1) {
                uniqueTypes.splice(processedIndex, 1);
                uniqueTypes.unshift('Processed');
            }
            
            const container = document.getElementById('product-tabs-header');
            
            if (!container) return; 

            if (!window.activeTab || !uniqueTypes.includes(window.activeTab)) {
                window.activeTab = uniqueTypes[0]; // Should default to 'Processed'
            }

            container.innerHTML = uniqueTypes.map(type => {
                const isActive = type === window.activeTab;
                return `
                    <button onclick="switchProductTab('${type}')"
                            class="product-tab px-4 py-2 text-sm md:text-base border-b-2 border-transparent transition hover:text-emerald-700 hover:border-emerald-300 ${isActive ? 'active-product-tab' : 'text-gray-500'}"
                            data-type="${type}">
                        ${type}
                    </button>
                `;
            }).join('');
            
            renderCutPillFilters();
            renderProductCatalog();
        };

        // Switches the active tab and triggers catalog refresh
        window.switchProductTab = (type) => {
            window.activeTab = type;
            const searchInput = document.getElementById('search-input');
            if(searchInput) searchInput.value = '';
            
            // Clear all filters when changing tabs for a clean slate
            window.activeFilters.search = '';
            window.activeFilters.cut = [];
            window.activeFilters.minRating = 0;
            window.activeFilters.minPrice = null;
            window.activeFilters.maxPrice = null;

            // Reset UI of static filters
            document.querySelectorAll('.rating-pill-button').forEach(btn => btn.classList.remove('rating-active'));
            const allRatingsBtn = document.querySelector('.rating-pill-button[data-rating="0"]');
            if(allRatingsBtn) allRatingsBtn.classList.add('rating-active');
            
            // Reset Price Slider UI
            initializePriceSlider();
            
            renderProductTabs(); 
        };

        // --- SCROLL PILL LOGIC ---

        window.scrollPills = (direction) => {
            const container = document.getElementById('pill-list-container');
            if (!container) return;

            const scrollDistance = 150; 
            let newScrollLeft = container.scrollLeft + direction;

            container.scrollTo({
                left: newScrollLeft,
                behavior: 'smooth'
            });
            
            setTimeout(checkScrollArrows, 350); 
        };

        const checkScrollArrows = () => {
            const container = document.getElementById('pill-list-container');
            const leftButton = document.getElementById('pill-scroll-left');
            const rightButton = document.getElementById('pill-scroll-right');
            
            if (!container || !leftButton || !rightButton) return;

            const scrollLeft = container.scrollLeft;
            const scrollWidth = container.scrollWidth;
            const clientWidth = container.clientWidth;

            if (scrollLeft > 5) { 
                leftButton.removeAttribute('disabled');
            } else {
                leftButton.setAttribute('disabled', 'true');
            }

            if (scrollLeft + clientWidth < scrollWidth - 5) { 
                rightButton.removeAttribute('disabled');
            } else {
                rightButton.setAttribute('disabled', 'true');
            }
        };

        // Renders the horizontal pill/tag cut filters (Option 2)
        const renderCutPillFilters = () => {
            const wrapper = document.getElementById('cut-pill-filter-bar-wrapper');
            const container = document.getElementById('pill-list-inner');
            const scrollContainer = document.getElementById('pill-list-container');

            if (!wrapper || !container || !window.activeTab || !scrollContainer) {
                if(wrapper) wrapper.classList.add('hidden');
                return;
            }

            const productsInActiveTab = window.products.filter(p => p.type === window.activeTab);
            const uniqueCuts = [...new Set(productsInActiveTab.map(p => p.cut))].sort();

            if (uniqueCuts.length === 0) {
                wrapper.classList.add('hidden');
                return;
            }

            wrapper.classList.remove('hidden');

            const allPills = uniqueCuts.map(value => {
                const isChecked = window.activeFilters.cut.includes(value);
                const activeClass = isChecked ? 'pill-active' : 'bg-gray-100 text-gray-700 hover:bg-gray-200';

                return `
                    <button onclick="handlePillClick(this, '${value}')"
                            class="px-4 py-1.5 rounded-full text-sm font-medium transition flex-shrink-0 ${activeClass}"
                            data-cut="${value}">
                        ${value}
                    </button>
                `;
            }).join('');

            container.innerHTML = allPills;
            
            scrollContainer.onscroll = null; 
            scrollContainer.addEventListener('scroll', checkScrollArrows);
            scrollContainer.scrollLeft = 0; 
            checkScrollArrows(); 
            lucide.createIcons(); 
        };
        
        // Handles the click event for the cut filter pills
        window.handlePillClick = (element, value) => {
            let filterArray = window.activeFilters.cut;

            const isCurrentlyActive = filterArray.includes(value);

            if (isCurrentlyActive) {
                window.activeFilters.cut = filterArray.filter(item => item !== value);
                element.classList.remove('pill-active');
                element.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            } else {
                window.activeFilters.cut.push(value);
                element.classList.add('pill-active');
                element.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            }
            
            renderProductCatalog(true); // True triggers scroll to product grid
        };

        // --- PRICE SLIDER LOGIC (UPDATED) ---
        
        const initializePriceSlider = () => {
            const { min, max } = getPriceBounds();
            
            const rangeMinEl = document.getElementById('range-min');
            const rangeMaxEl = document.getElementById('range-max');
            
            if (!rangeMinEl || !rangeMaxEl) return;

            // Set global max limits
            rangeMinEl.min = min;
            rangeMinEl.max = max;
            rangeMaxEl.min = min;
            rangeMaxEl.max = max;

            // Set current values to max/min bounds (initial state: no filter)
            let currentMin = window.activeFilters.minPrice || min;
            let currentMax = window.activeFilters.maxPrice || max;

            rangeMinEl.value = currentMin;
            rangeMaxEl.value = currentMax;

            // Update display and visual range immediately
            updatePriceSliderUI(currentMin, currentMax, min, max);
        };

        const updatePriceSliderUI = (minVal, maxVal, totalMin, totalMax) => {
            const rangeFillEl = document.getElementById('slider-range-fill');
            const minDisplayEl = document.getElementById('price-min-display');
            const maxDisplayEl = document.getElementById('price-max-display');

            if (!rangeFillEl || !minDisplayEl || !maxDisplayEl) return;

            minDisplayEl.textContent = formatCurrency(minVal);
            maxDisplayEl.textContent = formatCurrency(maxVal);

            // Calculate percentage for the colored fill
            const totalRange = totalMax - totalMin;
            const minPercent = ((minVal - totalMin) / totalRange) * 100;
            const maxPercent = ((maxVal - totalMin) / totalRange) * 100;

            rangeFillEl.style.left = `${minPercent}%`;
            rangeFillEl.style.width = `${maxPercent - minPercent}%`;
        };

        window.handleSliderChange = (id) => {
            const rangeMinEl = document.getElementById('range-min');
            const rangeMaxEl = document.getElementById('range-max');
            
            if (!rangeMinEl || !rangeMaxEl) return;

            let minVal = parseFloat(rangeMinEl.value);
            let maxVal = parseFloat(rangeMaxEl.value);

            // Ensure min slider cannot pass max slider
            if (minVal > maxVal) {
                if (id === 'range-min') {
                    minVal = maxVal;
                    rangeMinEl.value = maxVal;
                } else {
                    maxVal = minVal;
                    rangeMaxEl.value = minVal;
                }
            }
            
            // Get original bounds for UI update calculation
            const { min: totalMin, max: totalMax } = getPriceBounds();

            // Apply filter
            window.activeFilters.minPrice = minVal;
            window.activeFilters.maxPrice = maxVal;

            updatePriceSliderUI(minVal, maxVal, totalMin, totalMax);
            renderProductCatalog(true); // True triggers scroll to product grid
        };

        // NEW: Handles the minimum rating change
        window.handleRatingChange = (minRating) => {
            window.activeFilters.minRating = minRating;
            
            // Update UI for active button
            document.querySelectorAll('.rating-pill-button').forEach(btn => btn.classList.remove('rating-active'));
            const activeBtn = document.querySelector(`.rating-pill-button[data-rating="${minRating}"]`);
            if(activeBtn) activeBtn.classList.add('rating-active');
            
            renderProductCatalog(true); // True triggers scroll to product grid
        };


        // --- RENDERING FUNCTIONS ---
        
        // Helper function to generate star rating HTML
        const renderRating = (rating) => {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.25 && rating % 1 <= 0.75;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            
            let starsHtml = '';
            const starClass = "w-4 h-4 fill-yellow-400 text-yellow-400";
            
            for (let i = 0; i < fullStars; i++) {
                starsHtml += `<i data-lucide="star" class="${starClass}"></i>`;
            }
            if (halfStar) {
                starsHtml += `<span class="relative"><i data-lucide="star-half" class="${starClass}"></i></span>`;
            } else if (fullStars < 5) {
                starsHtml += `<span class="relative"><i data-lucide="star" class="w-4 h-4 text-gray-300"></i></span>`.repeat(emptyStars);
            }

            return `
                <div class="flex items-center space-x-0.5 mt-1">
                    ${starsHtml}
                    <span class="ml-2 text-sm font-semibold text-gray-700">${rating.toFixed(1)}</span>
                </div>
            `;
        };


        // Render individual product card
        const createProductCard = (product) => {
            const inCartQuantity = window.cart[product.id] ? window.cart[product.id].quantity : 0;
            const unitDisplay = product.unit ? `/ ${product.unit}` : '/ unit';

            return `
                <div id="product-${product.id}" 
                     onclick="renderProductDetailModal('${product.id}')"
                     class="bg-white p-4 rounded-xl card-shadow flex flex-col justify-between hover:ring-2 hover:ring-emerald-500 transition-all duration-300 cursor-pointer">
                    
                    <div class="flex justify-between items-start mb-3">
                         <!-- Product Image -->
                        <div class="w-1/4 flex-shrink-0 mr-3">
                            <img src="${product.imageUrl}" 
                                 alt="${product.name}" 
                                 class="w-full h-auto rounded-lg object-cover border border-gray-100" 
                                 onerror="this.onerror=null;this.src='https://placehold.co/100x100/A7F3D0/047857?text=No+Image';">
                        </div>
                        
                        <!-- Product Details & Rating -->
                        <div class="flex-grow">
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white bg-emerald-500">${product.type} - ${product.cut}</span>
                            <h3 class="text-lg font-bold text-gray-800 mt-2 leading-tight">${product.name}</h3>
                            <p class="text-sm text-gray-500">${product.brand} (SKU: ${product.sku})</p>
                            ${renderRating(product.rating)}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-end mt-2 pt-4 border-t border-gray-100">
                         <!-- Price -->
                        <div class="flex-grow">
                            <p class="text-xl font-extrabold text-emerald-700">${formatCurrency(product.unitPrice)} <span class="text-sm font-normal text-gray-500">${unitDisplay}</span></p>
                        </div>
                        
                        <!-- Quantity Controls -->
                        <div class="flex flex-col items-end">
                            <!-- This div stops the card click opening the modal when quantity buttons are pressed -->
                            <div class="flex items-center space-x-2" onclick="event.stopPropagation()">
                                <button onclick="updateCart('${product.id}', -1, false)" class="p-1.5 border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50 transition" ${inCartQuantity === 0 ? 'disabled' : ''}>
                                    <i data-lucide="minus" class="w-4 h-4"></i>
                                </button>
                                <span class="font-medium text-lg w-8 text-center" id="qty-${product.id}">${inCartQuantity}</span>
                                <button onclick="updateCart('${product.id}', 1, false)" class="p-1.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                             ${inCartQuantity > 0 ? `<span class="text-xs text-gray-600 font-medium mt-1">In Cart</span>` : `<span class="text-xs text-gray-400 mt-1">Add to order</span>`}
                        </div>
                    </div>
                </div>
            `;
        };
        
        // NEW: Function to handle the micro-interaction and add to cart from the detail modal
        const addToCartWithAnimation = (productId, quantity, buttonElement) => {
            // 1. Animate button
            buttonElement.textContent = "Added ";
            buttonElement.classList.add('button-clicked');
            buttonElement.disabled = true;

            // 2. Animate cart icon (item "flies" to cart)
            const cartButtonIcon = document.querySelector('#cart-button i');
            if (cartButtonIcon) {
                cartButtonIcon.classList.add('cart-highlight');
            }

            // 3. Perform the actual cart update
            updateCart(productId, quantity, true); 
            
            // 4. Revert state after delay
            setTimeout(() => {
                buttonElement.textContent = "Add to Cart";
                buttonElement.classList.remove('button-clicked');
                buttonElement.disabled = false;
                
                if (cartButtonIcon) {
                    cartButtonIcon.classList.remove('cart-highlight');
                }
                
                // Close the modal after the animation completes
                closeModal('product-detail-modal');
            }, 1000); 
        };

        // Render the Product Detail Modal
        window.renderProductDetailModal = (productId) => {
            const product = window.products.find(p => p.id === productId);
            const modal = document.getElementById('product-detail-modal');
            
            if (!product || !modal) return;
            
            const unitDisplay = product.unit ? `/ ${product.unit}` : '/ unit';
            
            // Populate content
            document.getElementById('detail-modal-title').textContent = product.name;
            document.getElementById('detail-image').src = product.imageUrl;
            document.getElementById('detail-sku').textContent = product.sku;
            document.getElementById('detail-brand').textContent = product.brand;
            document.getElementById('detail-inventory').textContent = `${product.inventory} ${product.unit}s remaining`;
            document.getElementById('detail-price').textContent = formatCurrency(product.unitPrice);
            document.getElementById('detail-unit').textContent = unitDisplay;
            document.getElementById('detail-rating').innerHTML = renderRating(product.rating);
            document.getElementById('detail-description').textContent = product.description;
            
            // Setup quantity controls
            const qtyInput = document.getElementById('detail-qty-input');
            if (qtyInput) qtyInput.value = 1; 
            
            const updateDetailQuantity = (change) => {
                const currentQty = parseInt(qtyInput.value, 10);
                const newQty = Math.max(1, currentQty + change);
                qtyInput.value = newQty;
            };

            const minusBtn = document.getElementById('detail-minus-btn');
            if (minusBtn) minusBtn.onclick = () => updateDetailQuantity(-1);
            
            const plusBtn = document.getElementById('detail-plus-btn');
            if (plusBtn) plusBtn.onclick = () => updateDetailQuantity(1);

            // Setup Add to Cart button (NOW CALLS THE ANIMATION FUNCTION)
            const addToCartBtn = document.getElementById('detail-add-to-cart-btn');
            if (addToCartBtn) {
                // Ensure the button is reset before applying new click handler
                addToCartBtn.textContent = "Add to Cart";
                addToCartBtn.classList.remove('button-clicked');
                addToCartBtn.disabled = false;
                
                addToCartBtn.onclick = (e) => {
                    const quantity = parseInt(qtyInput.value, 10);
                    // Pass the quantity and the button element itself
                    addToCartWithAnimation(productId, quantity, e.currentTarget); 
                };
            }

            // Show modal
            lucide.createIcons();
            modal.classList.remove('hidden');
        };

        // Render the main product catalog grid with sub-sections
        window.renderProductCatalog = (shouldScroll = false) => {
            const container = document.getElementById('product-grid');
            const searchInputEl = document.getElementById('search-input');
            const noProductsEl = document.getElementById('no-products');
            const scrollBox = document.getElementById('product-scroll-box'); // Target scroll box

            if (!container || !searchInputEl || !noProductsEl || !scrollBox || !window.activeTab) {
                return; 
            }
            
            const { search, cut, minRating, minPrice, maxPrice } = window.activeFilters;
            const searchInput = searchInputEl.value.toLowerCase();

            // 1. Filter products based on active tab, search, and selected cuts
            let filteredProducts = window.products.filter(p => p.type === window.activeTab);

            filteredProducts = filteredProducts.filter(p => {
                // Search Filter
                const searchMatch = (
                    p.name.toLowerCase().includes(searchInput) ||
                    p.sku.toLowerCase().includes(searchInput) ||
                    p.brand.toLowerCase().includes(searchInput)
                );
                
                // Cut Filter
                const cutMatch = cut.length === 0 || cut.includes(p.cut);
                
                // Rating Filter
                const ratingMatch = p.rating >= minRating;
                
                // Price Filter
                let priceMatch = true;
                if (minPrice !== null && p.unitPrice < minPrice) {
                    priceMatch = false;
                }
                if (maxPrice !== null && p.unitPrice > maxPrice) {
                    priceMatch = false;
                }

                return searchMatch && cutMatch && ratingMatch && priceMatch;
            }).sort((a, b) => {
                // Secondary sort: Sort by cut name, then product name for display order
                if (a.cut < b.cut) return -1;
                if (a.cut > b.cut) return 1;
                return a.name.localeCompare(b.name);
            });
            
            // 2. Group products by Cut for sub-sections
            const groupedByCut = filteredProducts.reduce((acc, product) => {
                (acc[product.cut] = acc[product.cut] || []).push(product);
                return acc;
            }, {});

            let htmlContent = '';
            
            if (filteredProducts.length > 0) {
                // 3. Iterate over grouped cuts and render sections
                for (const cut in groupedByCut) {
                    htmlContent += `
                        <section class="mb-8">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="tag" class="w-5 h-5 mr-2 text-emerald-600"></i>
                                ${cut} Cuts
                            </h2>
                            <!-- FIX: Changed grid layout to ensure 2 columns max (sm:grid-cols-2) on medium and large screens -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                ${groupedByCut[cut].map(createProductCard).join('')}
                            </div>
                        </section>
                    `;
                }
            }
            
            container.innerHTML = htmlContent;

            // Show/hide no products message (Control visibility on the scroll box's parent level)
            noProductsEl.classList.toggle('hidden', filteredProducts.length > 0);
            scrollBox.classList.toggle('hidden', filteredProducts.length === 0);

            // NEW FIX: Smooth scroll the scroll box back to top if a filter was applied
            if (shouldScroll) {
                 scrollBox.scrollTop = 0;
            }

            lucide.createIcons();
        };


        // Render distributor dashboard details
        window.renderDashboard = () => {
            if (!window.distributorProfile) return;

            const { creditLimit, outstandingBalance } = window.distributorProfile;
            const availableCredit = creditLimit - outstandingBalance;
            const utilization = (outstandingBalance / creditLimit) * 100;

            const creditLimitEl = document.getElementById('credit-limit');
            const creditUsedEl = document.getElementById('credit-used');
            const creditAvailableEl = document.getElementById('credit-available');
            const utilizationBar = document.getElementById('utilization-bar');
            const utilizationPercent = document.getElementById('utilization-percent');
            
            if (creditLimitEl) creditLimitEl.textContent = formatCurrency(creditLimit);
            if (creditUsedEl) creditUsedEl.textContent = formatCurrency(outstandingBalance);
            if (creditAvailableEl) creditAvailableEl.textContent = formatCurrency(availableCredit);
            
            if (utilizationBar && utilizationPercent) {
                utilizationBar.style.width = `${Math.min(utilization, 100)}%`;
                utilizationPercent.textContent = `${Math.min(utilization.toFixed(1), 100)}%`;
                
                if (utilization > 80) {
                    utilizationBar.classList.remove('bg-emerald-600');
                    utilizationBar.classList.add('bg-red-500');
                } else {
                    utilizationBar.classList.remove('bg-red-500');
                    utilizationBar.classList.add('bg-emerald-600');
                }
            }

            renderOrderHistory(window.orders);
        };

        // Render order history table
        const renderOrderHistory = (orders) => {
            const container = document.getElementById('order-history-body');
            if (!container) return;
            
            if (orders.length === 0) {
                container.innerHTML = `<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No orders placed yet.</td></tr>`;
                return;
            }

            // Sort by latest date. Now using standard JS Date objects.
            orders.sort((a, b) => b.timestamp - a.timestamp);

            container.innerHTML = orders.map(order => {
                const date = order.timestamp ? new Date(order.timestamp).toLocaleDateString() : 'N/A';
                const statusColor = {
                    'Delivered': 'bg-green-100 text-green-800',
                    'Shipped': 'bg-blue-100 text-blue-800',
                    'Processing': 'bg-yellow-100 text-yellow-800',
                    'Canceled': 'bg-red-100 text-red-800'
                }[order.status] || 'bg-gray-100 text-gray-800';

                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.id.substring(0, 8)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-emerald-600">${formatCurrency(order.totalAmount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${order.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 hover:text-blue-800 cursor-pointer">
                            ${order.status === 'Shipped' ? 'Tracking Link' : 'View Details'}
                        </td>
                    </tr>
                `;
            }).join('');
        };

        // --- CART LOGIC ---
        
        window.updateCart = (productId, value, isSetQuantity = false) => {
            const product = window.products.find(p => p.id === productId);
            if (!product) return;

            let newQuantity;

            if (isSetQuantity) {
                newQuantity = Math.max(0, value);
            } else {
                const currentQty = window.cart[productId] ? window.cart[productId].quantity : 0;
                newQuantity = Math.max(0, currentQty + value);
            }

            if (newQuantity > 0) {
                window.cart[productId] = { ...product, quantity: newQuantity, unit: product.unit };
            } else {
                delete window.cart[productId];
            }

            renderProductCatalog();
            const cartModal = document.getElementById('cart-modal');
            
            // FIX: Ensure cart modal content is updated if it is currently visible.
            if (cartModal && !cartModal.classList.contains('hidden')) {
                renderCartModal();
            }
            
            updateCartCount();
        };

        const updateCartCount = () => {
            const count = Object.values(window.cart).reduce((sum, item) => sum + item.quantity, 0);
            const cartCountEl = document.getElementById('cart-count');
            if (cartCountEl) {
                cartCountEl.textContent = count;
            }
        };

        // Render the cart modal content
        window.renderCartModal = () => {
            const container = document.getElementById('cart-items-container');
            const subtotalEl = document.getElementById('cart-subtotal');
            const emptyMsg = document.getElementById('empty-cart-message');
            const placeOrderBtn = document.getElementById('place-order-button');
            const creditWarning = document.getElementById('credit-warning');
            
            if (!container || !subtotalEl || !emptyMsg || !placeOrderBtn || !creditWarning) return;

            const cartItems = Object.values(window.cart);
            let subtotal = 0;

            if (cartItems.length === 0) {
                container.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                subtotalEl.textContent = formatCurrency(0);
                placeOrderBtn.disabled = true;
                creditWarning.classList.add('hidden');
                return;
            }

            emptyMsg.classList.add('hidden');
            container.innerHTML = cartItems.map(item => {
                const lineTotal = item.unitPrice * item.quantity;
                subtotal += lineTotal;
                const unitText = item.unit ? `(${item.unit})` : '';

                return `
                    <div class="flex items-center justify-between border-b last:border-b-0 py-3">
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-500">${item.sku}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="updateCart('${item.id}', -1, false)" class="text-gray-500 hover:text-red-500 transition"><i data-lucide="minus-circle" class="w-5 h-5"></i></button>
                            <span class="font-medium w-12 text-center">${item.quantity} ${unitText}</span>
                            <button onclick="updateCart('${item.id}', 1, false)" class="text-gray-500 hover:text-emerald-500 transition"><i data-lucide="plus-circle" class="w-5 h-5"></i></button>
                        </div>
                        <span class="text-sm font-bold w-24 text-right">${formatCurrency(lineTotal)}</span>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons(); 

            subtotalEl.textContent = formatCurrency(subtotal);

            const availableCredit = window.distributorProfile.creditLimit - window.distributorProfile.outstandingBalance;
            
            if (subtotal > availableCredit) {
                creditWarning.classList.remove('hidden');
                placeOrderBtn.disabled = true;
                placeOrderBtn.textContent = 'Credit Limit Exceeded';
            } else {
                creditWarning.classList.add('hidden');
                placeOrderBtn.disabled = false;
                placeOrderBtn.textContent = 'Place Order';
            }
        };

        // Place the order (Synchronous update of local state)
        window.placeOrder = () => {
            const cartItems = Object.values(window.cart);
            if (cartItems.length === 0) return;

            const totalAmount = cartItems.reduce((sum, item) => sum + item.unitPrice * item.quantity, 0);
            
            if (totalAmount > (window.distributorProfile.creditLimit - window.distributorProfile.outstandingBalance)) {
                showMessage("Order Failed", "The total amount exceeds your available credit line. Please adjust your order.");
                return;
            }

            closeModal('cart-modal');
            showMessage("Order Placed", "Your order has been placed!");

            try {
                // 1. Create the Order Document
                const newOrder = {
                    id: generateMockOrderId(),
                    distributorId: MOCK_USER_ID,
                    items: cartItems.map(item => ({
                        id: item.id,
                        sku: item.sku,
                        name: item.name,
                        unitPrice: item.unitPrice,
                        quantity: item.quantity,
                        unit: item.unit 
                    })),
                    totalAmount: totalAmount,
                    status: 'Processing',
                    timestamp: new Date(), // Use current JS date
                };
                
                // Update global state
                window.orders.push(newOrder);

                // 2. Update Distributor Credit Line (Local State Only)
                window.distributorProfile.outstandingBalance += totalAmount;
                
                // 3. Clear the Cart and notify
                window.cart = {};
                updateCartCount();
                renderProductCatalog();
                // Re-render dashboard to show updated balance and new order
                renderDashboard();
                showMessage("Order Placed Successfully!", `Your order for ${formatCurrency(totalAmount)} has been placed and your outstanding balance has been updated locally.`);

            } catch (error) {
                console.error("Order Placement Error:", error);
                showMessage("Order Failed", "There was an error placing your order. (Details in console)");
            }
        };

        // --- SIDEBAR COLLAPSE LOGIC ---
        
        const toggleSidebar = () => {
            isSidebarCollapsed = !isSidebarCollapsed;

            const sidebar = document.getElementById('left-nav-sidebar');
            const viewContainer = document.getElementById('view-container');
            const toggleIcon = document.getElementById('toggle-icon');
            const sidebarTitle = document.getElementById('sidebar-title');
            
            if (!sidebar || !viewContainer || !toggleIcon || !sidebarTitle) return;

            sidebar.classList.toggle('lg:col-span-2', !isSidebarCollapsed);
            sidebar.classList.toggle('lg:col-span-1', isSidebarCollapsed);
            
            viewContainer.classList.toggle('lg:col-span-10', !isSidebarCollapsed);
            viewContainer.classList.toggle('lg:col-span-11', isSidebarCollapsed);

            document.querySelectorAll('#sidebar-content .nav-tab').forEach(button => {
                button.classList.toggle('justify-center', isSidebarCollapsed); 
                button.classList.toggle('text-left', !isSidebarCollapsed); 
                button.classList.toggle('px-3', !isSidebarCollapsed); 
                button.classList.toggle('px-1', isSidebarCollapsed); 
            });

            document.querySelectorAll('.sidebar-text').forEach(el => {
                el.classList.toggle('opacity-0', isSidebarCollapsed);
                el.classList.toggle('hidden', isSidebarCollapsed);
            });
            
            sidebarTitle.classList.toggle('hidden', isSidebarCollapsed);

            document.querySelectorAll('.nav-icon').forEach(el => {
                 el.classList.toggle('mr-2', !isSidebarCollapsed);
                 el.classList.toggle('mr-0', isSidebarCollapsed);
            });
            
            toggleIcon.setAttribute('data-lucide', isSidebarCollapsed ? 'chevron-right' : 'chevron-left');
            
            lucide.createIcons();
        };

        // --- UI EVENT HANDLERS ---
        
        const setupEventListeners = () => {
            const cartButton = document.getElementById('cart-button');
            if (cartButton) {
                cartButton.addEventListener('click', () => {
                    renderCartModal();
                    document.getElementById('cart-modal').classList.remove('hidden');
                });
            }
            
            const sidebarToggle = document.getElementById('sidebar-toggle-desktop');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const clickedButton = e.target.closest('.nav-tab');
                    if (!clickedButton) return; 

                    const targetViewId = clickedButton.getAttribute('data-target');

                    document.querySelectorAll('#left-nav-sidebar .nav-tab').forEach(t => {
                        t.classList.remove('active-nav-tab');
                        t.classList.add('text-gray-700', 'hover:bg-gray-100');
                    });
                    const desktopButton = document.querySelector(`#left-nav-sidebar .nav-tab[data-target="${targetViewId}"]`);
                    if (desktopButton) {
                        desktopButton.classList.add('active-nav-tab');
                        desktopButton.classList.remove('text-gray-700', 'hover:bg-gray-100');
                    }
                    
                    document.querySelectorAll('#mobile-nav-drawer .nav-tab').forEach(t => {
                        t.classList.remove('active-nav-tab');
                        t.classList.add('text-gray-700', 'hover:bg-gray-100');
                    });
                    const mobileButton = document.querySelector(`#mobile-nav-drawer .nav-tab[data-target="${targetViewId}"]`);
                    if (mobileButton) {
                        mobileButton.classList.add('active-nav-tab');
                        mobileButton.classList.remove('text-gray-700', 'hover:bg-gray-100');
                    }


                    document.querySelectorAll('.view').forEach(view => {
                        view.classList.add('hidden');
                    });
                    const targetView = document.getElementById(targetViewId);
                    if (targetView) {
                        targetView.classList.remove('hidden');
                    }
                    
                    const mobileDrawer = document.getElementById('mobile-nav-drawer');
                    if (mobileDrawer) {
                        mobileDrawer.classList.add('hidden');
                    }


                    if (targetViewId === 'dashboard-view') {
                        renderDashboard();
                    } else if (targetViewId === 'catalog-view') {
                        renderProductTabs();
                    }
                    
                    lucide.createIcons();
                });
            });

            const mobileNavToggle = document.getElementById('mobile-nav-toggle');
            if (mobileNavToggle) {
                mobileNavToggle.addEventListener('click', () => {
                    const mobileDrawer = document.getElementById('mobile-nav-drawer');
                    if (mobileDrawer) {
                        mobileDrawer.classList.remove('hidden');
                    }
                });
            }

            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                // Pass true to trigger scroll on search input changes
                searchInput.addEventListener('input', () => renderProductCatalog(true));
            }

            const navSidebar = document.getElementById('left-nav-sidebar');
            if (navSidebar && window.innerWidth >= 1024) { 
                navSidebar.classList.remove('hidden');
            }
            
            // Initial data load and render
            initializeApplicationData();
        };

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupEventListeners();
        });

    </script>
</body>
</html>
